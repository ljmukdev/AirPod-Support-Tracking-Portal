<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Edit Consumable | LJM Admin</title>
    <link rel="stylesheet" href="../css/styles.css?v=1.2.6">
    <link rel="stylesheet" href="../css/ios-mobile-optimizations.css">
    <style>
        .form-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        .form-group-full {
            grid-column: 1 / -1;
        }
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        .success-banner {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .error-banner {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .stock-adjustment {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stock-adjustment h3 {
            margin-top: 0;
            font-size: 1rem;
            color: #495057;
        }
        .stock-adjust-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
    </style>
</head>
<body class="admin-panel">
    <!-- Sidebar (same as consumables.html) -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-circle">
                    <span class="logo-text">LJM</span>
                </div>
                <div>
                    <div class="sidebar-logo-text">LJM Admin</div>
                    <div class="sidebar-subtitle">Dashboard</div>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-header">ADMIN</div>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 10L9 4L9 10L17 10M3 10L3 16M3 10L17 10M17 10L17 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="parts.html" class="nav-link">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="3" width="6" height="6" stroke="currentColor" stroke-width="1.5"/>
                                <rect x="11" y="3" width="6" height="6" stroke="currentColor" stroke-width="1.5"/>
                                <rect x="3" y="11" width="6" height="6" stroke="currentColor" stroke-width="1.5"/>
                                <rect x="11" y="11" width="6" height="6" stroke="currentColor" stroke-width="1.5"/>
                            </svg>
                            <span>Manage Parts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="products.html" class="nav-link">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 4H16V16H4V4Z" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M4 8H16" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M8 4V16" stroke="currentColor" stroke-width="1.5"/>
                            </svg>
                            <span>Products</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="purchases.html" class="nav-link">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 5L10 2L17 5M3 5L3 15L10 18M3 5L10 8M17 5L17 15L10 18M17 5L10 8M10 8L10 18" stroke="currentColor" stroke-width="1.5"/>
                            </svg>
                            <span>Purchases</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="consumables.html" class="nav-link active">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 3H17V8H3V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M3 10H17V15H3V10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 3V8M13 3V8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M7 10V15M13 10V15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            <span>Consumables</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="check-in.html" class="nav-link">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7 10L9 12L13 8M18 10C18 14.4183 14.4183 18 10 18C5.58172 18 2 14.4183 2 10C2 5.58172 5.58172 2 10 2C14.4183 2 18 5.58172 18 10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Check-In</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="sidebar-footer">
            <button class="sidebar-footer-link sidebar-logout" id="logoutButton">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 15L17 10L13 5M17 10H7" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M7 3H4C3.44772 3 3 3.44772 3 4V16C3 16.5523 3.44772 17 4 17H7" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="admin-main">
        <header class="admin-topbar">
            <div class="topbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 5H17M3 10H17M3 15H17" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                </button>
                <form class="topbar-search-form" action="search-product.html" method="get">
                    <input
                        type="text"
                        name="security_barcode"
                        class="topbar-search-input"
                        placeholder="Search products..."
                        autocomplete="off"
                    >
                    <button type="submit" class="topbar-search-button" aria-label="Search">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8.33333 13.6667C11.2789 13.6667 13.6667 11.2789 13.6667 8.33333C13.6667 5.38781 11.2789 3 8.33333 3C5.38781 3 3 5.38781 3 8.33333C3 11.2789 5.38781 13.6667 8.33333 13.6667Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M15 15L12.1 12.1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </form>
                <div class="topbar-actions">
                    <a href="search-product.html" class="topbar-action-button is-secondary">Search Products</a>
                    <a href="parts.html" class="topbar-action-button">Add Part</a>
                    <a href="add-product.html" class="topbar-action-button">Add Product</a>
                    <a href="add-purchase.html" class="topbar-action-button">Add Purchase</a>
                    <a href="addon-sales.html" class="topbar-action-button">Add Sale</a>
                </div>
            </div>
            <div class="topbar-right">
                <a href="consumables.html" class="button button-secondary" style="padding: 8px 16px; font-size: 0.9rem;">
                    ‚Üê Back to Inventory
                </a>
            </div>
        </header>

        <div class="admin-content">
            <div class="form-container">
                <div id="successBanner" class="success-banner"></div>
                <div id="errorBanner" class="error-banner"></div>

                <h1>Edit Consumable Item</h1>
                <p style="color: #666; margin-bottom: 30px;">Update item details or adjust stock levels</p>

                <!-- Stock Adjustment Section -->
                <div class="stock-adjustment form-group-full">
                    <h3>Quick Stock Adjustment</h3>
                    <p style="color: #666; margin-bottom: 10px;">Current stock: <strong id="currentStock">-</strong></p>
                    <div class="stock-adjust-controls">
                        <input type="number" id="stockAdjustment" placeholder="Enter adjustment (+/-)" style="width: 200px;">
                        <input type="text" id="adjustmentReason" placeholder="Reason (optional)" style="flex: 1;">
                        <button type="button" class="button button-primary" id="adjustStockBtn">Apply Adjustment</button>
                    </div>
                    <p style="font-size: 0.875rem; color: #666; margin-top: 8px;">
                        Example: Enter +50 to add 50 units, or -10 to remove 10 units
                    </p>
                </div>

                <!-- Reorder Suggestions Section -->
                <div id="reorderSuggestionsSection" class="stock-adjustment form-group-full" style="display: none; background: #e7f3ff; border: 1px solid #0dcaf0;">
                    <h3>üìä Smart Reorder Suggestions</h3>
                    <div id="suggestionsContent">
                        <p style="color: #666;">Loading suggestions...</p>
                    </div>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">

                <form id="editConsumableForm">
                    <div class="form-grid">
                        <!-- Item Name -->
                        <div class="form-group">
                            <label for="itemName">Item Name *</label>
                            <input type="text" id="itemName" name="itemName" required placeholder="e.g., USB-C Cable">
                        </div>

                        <!-- SKU -->
                        <div class="form-group">
                            <label for="sku">SKU *</label>
                            <input type="text" id="sku" name="sku" required placeholder="e.g., PKG-BUBBLE-SM-001" style="text-transform: uppercase;">
                            <p style="font-size: 0.875rem; color: #666; margin-top: 4px;">
                                Format: CATEGORY-NAME-SIZE-### (or CATEGORY-NAME-### if no size)
                            </p>
                        </div>

                        <!-- Category -->
                        <div class="form-group">
                            <label for="category">Category *</label>
                            <select id="category" name="category" required>
                                <option value="">Select category</option>
                                <option value="packaging">Packaging</option>
                                <option value="shipping">Shipping</option>
                                <option value="cleaning">Cleaning</option>
                                <option value="cables">Cables</option>
                                <option value="ear-tips">Ear Tips</option>
                                <option value="protective">Protective Cases</option>
                                <option value="labels">Labels</option>
                                <option value="general">General</option>
                            </select>
                        </div>

                        <!-- Size -->
                        <div class="form-group">
                            <label for="size">Size / Variant</label>
                            <input type="text" id="size" name="size" placeholder="e.g., Small, 1m, 100ml">
                            <p style="font-size: 0.75rem; color: #666; margin-top: 4px;">Optional: S/M/L, dimensions, volume, etc.</p>
                        </div>

                        <!-- Unit Type -->
                        <div class="form-group">
                            <label for="unitType">Unit Type *</label>
                            <select id="unitType" name="unitType" required>
                                <option value="">Select unit</option>
                                <option value="piece">Piece</option>
                                <option value="pack">Pack</option>
                                <option value="box">Box</option>
                                <option value="meter">Meter</option>
                                <option value="roll">Roll</option>
                                <option value="bottle">Bottle</option>
                                <option value="set">Set</option>
                            </select>
                        </div>

                        <!-- Quantity in Stock -->
                        <div class="form-group">
                            <label for="quantityInStock">Current Stock Quantity *</label>
                            <input type="number" id="quantityInStock" name="quantityInStock" required min="0" step="1" placeholder="0">
                        </div>

                        <!-- Unit Cost -->
                        <div class="form-group">
                            <label for="unitCost">Unit Cost (¬£)</label>
                            <input type="number" id="unitCost" name="unitCost" min="0" step="0.01" placeholder="0.00">
                        </div>

                        <!-- Reorder Level -->
                        <div class="form-group">
                            <label for="reorderLevel">Reorder Level
                                <button type="button" id="applySuggestedLevel" class="button button-small" style="display: none; margin-left: 8px; padding: 2px 8px; font-size: 0.75rem;">
                                    Use Suggested
                                </button>
                            </label>
                            <input type="number" id="reorderLevel" name="reorderLevel" min="0" step="1" placeholder="Alert when stock reaches this level">
                            <p id="suggestedLevelHint" style="font-size: 0.75rem; color: #0dcaf0; margin-top: 4px; display: none;"></p>
                        </div>

                        <!-- Reorder Quantity -->
                        <div class="form-group">
                            <label for="reorderQuantity">Reorder Quantity
                                <button type="button" id="applySuggestedQuantity" class="button button-small" style="display: none; margin-left: 8px; padding: 2px 8px; font-size: 0.75rem;">
                                    Use Suggested
                                </button>
                            </label>
                            <input type="number" id="reorderQuantity" name="reorderQuantity" min="0" step="1" placeholder="How much to reorder">
                            <p id="suggestedQuantityHint" style="font-size: 0.75rem; color: #0dcaf0; margin-top: 4px; display: none;"></p>
                        </div>

                        <!-- Supplier -->
                        <div class="form-group">
                            <label for="supplier">Supplier</label>
                            <input type="text" id="supplier" name="supplier" placeholder="Supplier name">
                        </div>

                        <!-- Product URL -->
                        <div class="form-group">
                            <label for="productUrl">Product Link / URL</label>
                            <input type="url" id="productUrl" name="productUrl" placeholder="https://example.com/product">
                            <p style="font-size: 0.75rem; color: #666; margin-top: 4px;">Link to product page or supplier listing</p>
                        </div>

                        <!-- Lead Time -->
                        <div class="form-group">
                            <label for="leadTime">Lead Time (days)</label>
                            <input type="number" id="leadTime" name="leadTime" min="0" step="1" placeholder="e.g., 7">
                            <p style="font-size: 0.75rem; color: #666; margin-top: 4px;">How many days from order to delivery</p>
                        </div>

                        <!-- Location -->
                        <div class="form-group">
                            <label for="location">Storage Location</label>
                            <input type="text" id="location" name="location" placeholder="e.g., Shelf A1">
                        </div>

                        <!-- Status -->
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" name="status">
                                <option value="active">Active</option>
                                <option value="discontinued">Discontinued</option>
                            </select>
                        </div>

                        <!-- Expiry Date -->
                        <div class="form-group">
                            <label for="expiryDate">Expiry Date (if applicable)</label>
                            <input type="date" id="expiryDate" name="expiryDate">
                        </div>

                        <!-- Description -->
                        <div class="form-group form-group-full">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="3" placeholder="Additional details about this item"></textarea>
                        </div>

                        <!-- Notes -->
                        <div class="form-group form-group-full">
                            <label for="notes">Notes</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="Internal notes"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="button delete-btn" id="deleteButton">
                            Delete Item
                        </button>
                        <div style="display: flex; gap: 15px;">
                            <a href="consumables.html" class="button button-secondary">Cancel</a>
                            <button type="submit" class="button button-primary" id="submitButton">
                                Update Consumable
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <script src="../js/admin.js?v=1.0.6"></script>
    <script src="../js/main.js?v=1.0.0"></script>
    <script>
        let consumableId = null;

        // Sidebar toggle functionality
        (function() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.admin-sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('sidebar-open');
                    if (overlay) {
                        overlay.classList.toggle('active');
                    }
                });

                if (overlay) {
                    overlay.addEventListener('click', function() {
                        sidebar.classList.remove('sidebar-open');
                        overlay.classList.remove('active');
                    });
                }
            }
        })();

        // Load consumable data
        async function loadConsumable() {
            const urlParams = new URLSearchParams(window.location.search);
            consumableId = urlParams.get('id');

            if (!consumableId) {
                document.getElementById('errorBanner').textContent = 'No consumable ID provided';
                document.getElementById('errorBanner').style.display = 'block';
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/admin/consumables/${consumableId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load consumable');
                }

                const data = await response.json();
                const consumable = data.consumable;

                // Populate form fields
                document.getElementById('itemName').value = consumable.item_name || '';
                document.getElementById('sku').value = consumable.sku || '';
                document.getElementById('category').value = consumable.category || 'general';
                document.getElementById('size').value = consumable.size || '';
                document.getElementById('description').value = consumable.description || '';
                document.getElementById('unitType').value = consumable.unit_type || '';
                document.getElementById('quantityInStock').value = consumable.quantity_in_stock || 0;
                document.getElementById('reorderLevel').value = consumable.reorder_level || '';
                document.getElementById('reorderQuantity').value = consumable.reorder_quantity || '';
                document.getElementById('unitCost').value = consumable.unit_cost || '';
                document.getElementById('supplier').value = consumable.supplier || '';
                document.getElementById('productUrl').value = consumable.product_url || '';
                document.getElementById('leadTime').value = consumable.lead_time_days || '';
                document.getElementById('location').value = consumable.location || '';
                document.getElementById('status').value = consumable.status || 'active';
                document.getElementById('notes').value = consumable.notes || '';

                // Update current stock display
                document.getElementById('currentStock').textContent = consumable.quantity_in_stock + ' ' + consumable.unit_type;

                // Handle expiry date
                if (consumable.expiry_date) {
                    const date = new Date(consumable.expiry_date);
                    document.getElementById('expiryDate').value = date.toISOString().split('T')[0];
                }

                // Load reorder suggestions
                loadReorderSuggestions();

            } catch (error) {
                console.error('Error loading consumable:', error);
                document.getElementById('errorBanner').textContent = error.message;
                document.getElementById('errorBanner').style.display = 'block';
            }
        }

        // Load reorder suggestions based on usage history
        let suggestedReorderLevel = null;
        let suggestedReorderQuantity = null;

        async function loadReorderSuggestions() {
            try {
                const response = await authenticatedFetch(`/api/admin/consumables/${consumableId}/reorder-suggestions`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    return; // Silently fail, suggestions are optional
                }

                const data = await response.json();
                const suggestions = data.suggestions;

                if (!suggestions.has_data) {
                    // Show message that no data is available
                    document.getElementById('suggestionsContent').innerHTML = `
                        <p style="color: #666; margin: 0;">
                            ${suggestions.message}
                        </p>
                    `;
                    document.getElementById('reorderSuggestionsSection').style.display = 'block';
                    return;
                }

                // Display suggestions
                let suggestionsHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                        <div>
                            <strong>Daily Usage Rate:</strong><br>
                            ${suggestions.daily_usage_rate} ${document.getElementById('unitType').value}/day
                        </div>
                        <div>
                            <strong>Days Until Stockout:</strong><br>
                            ${suggestions.days_until_stockout !== null ? suggestions.days_until_stockout + ' days' : 'N/A'}
                        </div>
                `;

                if (suggestions.suggested_reorder_date) {
                    const reorderDate = new Date(suggestions.suggested_reorder_date);
                    suggestionsHTML += `
                        <div>
                            <strong>Suggested Reorder Date:</strong><br>
                            ${reorderDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}
                        </div>
                    `;
                }

                suggestionsHTML += `
                        <div>
                            <strong>Suggested Reorder Quantity:</strong><br>
                            ${suggestions.suggested_reorder_quantity} ${document.getElementById('unitType').value}
                        </div>
                    </div>
                    <p style="margin: 15px 0 0 0; padding: 10px; background: white; border-radius: 4px;">
                        <strong>${suggestions.message}</strong>
                    </p>
                `;

                document.getElementById('suggestionsContent').innerHTML = suggestionsHTML;
                document.getElementById('reorderSuggestionsSection').style.display = 'block';

                // Store suggestions for use with buttons
                if (suggestions.daily_usage_rate > 0) {
                    // Suggest reorder level as 7-14 days of stock
                    suggestedReorderLevel = Math.ceil(suggestions.daily_usage_rate * 10);
                }
                suggestedReorderQuantity = suggestions.suggested_reorder_quantity;

                // Show "Use Suggested" buttons and hints
                if (suggestedReorderLevel) {
                    document.getElementById('applySuggestedLevel').style.display = 'inline-block';
                    document.getElementById('suggestedLevelHint').textContent = `üí° Suggested: ${suggestedReorderLevel}`;
                    document.getElementById('suggestedLevelHint').style.display = 'block';
                }

                if (suggestedReorderQuantity) {
                    document.getElementById('applySuggestedQuantity').style.display = 'inline-block';
                    document.getElementById('suggestedQuantityHint').textContent = `üí° Suggested: ${suggestedReorderQuantity} (30 days supply)`;
                    document.getElementById('suggestedQuantityHint').style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading suggestions:', error);
                // Silently fail, suggestions are optional
            }
        }

        // Apply suggested values buttons
        document.getElementById('applySuggestedLevel').addEventListener('click', function() {
            if (suggestedReorderLevel) {
                document.getElementById('reorderLevel').value = suggestedReorderLevel;
            }
        });

        document.getElementById('applySuggestedQuantity').addEventListener('click', function() {
            if (suggestedReorderQuantity) {
                document.getElementById('reorderQuantity').value = suggestedReorderQuantity;
            }
        });

        // Stock adjustment handler
        document.getElementById('adjustStockBtn').addEventListener('click', async function() {
            const adjustment = parseInt(document.getElementById('stockAdjustment').value);
            const reason = document.getElementById('adjustmentReason').value.trim();
            const successBanner = document.getElementById('successBanner');
            const errorBanner = document.getElementById('errorBanner');

            if (!adjustment || adjustment === 0) {
                errorBanner.textContent = 'Please enter a valid adjustment amount';
                errorBanner.style.display = 'block';
                successBanner.style.display = 'none';
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/admin/consumables/${consumableId}/adjust-stock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adjustment, reason }),
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to adjust stock');
                }

                const data = await response.json();

                // Update displays
                const unitType = document.getElementById('unitType').value;
                document.getElementById('currentStock').textContent = data.new_quantity + ' ' + unitType;
                document.getElementById('quantityInStock').value = data.new_quantity;

                // Clear adjustment fields
                document.getElementById('stockAdjustment').value = '';
                document.getElementById('adjustmentReason').value = '';

                // Show success message
                successBanner.textContent = `Stock adjusted successfully! New quantity: ${data.new_quantity}`;
                successBanner.style.display = 'block';
                errorBanner.style.display = 'none';

                // Reload suggestions with updated data
                loadReorderSuggestions();

                window.scrollTo(0, 0);

            } catch (error) {
                console.error('Error adjusting stock:', error);
                errorBanner.textContent = error.message;
                errorBanner.style.display = 'block';
                successBanner.style.display = 'none';
                window.scrollTo(0, 0);
            }
        });

        // Form submission handler
        document.getElementById('editConsumableForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = document.getElementById('submitButton');
            const successBanner = document.getElementById('successBanner');
            const errorBanner = document.getElementById('errorBanner');

            successBanner.style.display = 'none';
            errorBanner.style.display = 'none';

            submitButton.disabled = true;
            submitButton.textContent = 'Updating...';

            const formData = {
                item_name: document.getElementById('itemName').value.trim(),
                sku: document.getElementById('sku').value.trim().toUpperCase(),
                category: document.getElementById('category').value,
                size: document.getElementById('size').value.trim(),
                description: document.getElementById('description').value.trim(),
                unit_type: document.getElementById('unitType').value,
                quantity_in_stock: parseInt(document.getElementById('quantityInStock').value),
                reorder_level: document.getElementById('reorderLevel').value ? parseInt(document.getElementById('reorderLevel').value) : null,
                reorder_quantity: document.getElementById('reorderQuantity').value ? parseInt(document.getElementById('reorderQuantity').value) : null,
                unit_cost: document.getElementById('unitCost').value ? parseFloat(document.getElementById('unitCost').value) : null,
                supplier: document.getElementById('supplier').value.trim(),
                product_url: document.getElementById('productUrl').value.trim(),
                lead_time_days: document.getElementById('leadTime').value ? parseInt(document.getElementById('leadTime').value) : null,
                location: document.getElementById('location').value.trim(),
                status: document.getElementById('status').value,
                expiry_date: document.getElementById('expiryDate').value || null,
                notes: document.getElementById('notes').value.trim()
            };

            try {
                const response = await authenticatedFetch(`/api/admin/consumables/${consumableId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update consumable');
                }

                successBanner.textContent = 'Consumable updated successfully!';
                successBanner.style.display = 'block';
                window.scrollTo(0, 0);

                setTimeout(() => {
                    window.location.href = 'consumables.html';
                }, 2000);

            } catch (error) {
                console.error('Error updating consumable:', error);
                errorBanner.textContent = error.message;
                errorBanner.style.display = 'block';
                window.scrollTo(0, 0);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Update Consumable';
            }
        });

        // Delete handler
        document.getElementById('deleteButton').addEventListener('click', async function() {
            if (!confirm('Are you sure you want to delete this consumable? This action cannot be undone.')) {
                return;
            }

            const errorBanner = document.getElementById('errorBanner');

            try {
                const response = await authenticatedFetch(`/api/admin/consumables/${consumableId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete consumable');
                }

                alert('Consumable deleted successfully');
                window.location.href = 'consumables.html';

            } catch (error) {
                console.error('Error deleting consumable:', error);
                errorBanner.textContent = error.message;
                errorBanner.style.display = 'block';
                window.scrollTo(0, 0);
            }
        });

        // Auto-uppercase SKU field
        document.getElementById('sku').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // Load data on page load
        loadConsumable();
    </script>
</body>
</html>
