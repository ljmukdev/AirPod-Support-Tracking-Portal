<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Product | LJM Admin</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .search-form {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .search-form h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-navy);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 3px rgba(0, 164, 180, 0.1);
        }
        .search-button {
            background: var(--accent-teal);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-button:hover {
            background: #008a9a;
        }
        .search-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results-container {
            display: none;
        }
        .product-details {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .product-details h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-navy);
            border-bottom: 2px solid var(--accent-teal);
            padding-bottom: 10px;
        }
        .warranty-details {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .warranty-details h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-navy);
            border-bottom: 2px solid var(--accent-teal);
            padding-bottom: 10px;
        }
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .detail-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .detail-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .detail-value {
            color: var(--text-dark);
            font-size: 1rem;
            word-break: break-word;
        }
        .detail-value.null {
            color: #999;
            font-style: italic;
        }
        .no-warranty {
            text-align: center;
            padding: 40px;
            color: #666;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .no-warranty h3 {
            margin-bottom: 10px;
            color: var(--primary-navy);
        }
        .not-found {
            background: #f8d7da;
            color: #721c24;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        .not-found h2 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            display: none;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .photo-item {
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-active {
            background-color: #28a745;
            color: white;
        }
        .status-paid {
            background-color: #007bff;
            color: white;
        }
        .status-free {
            background-color: #6c757d;
            color: white;
        }
        .address-block {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-top: 5px;
        }
    </style>
    <script>
        // Inline version display
        (function() {
            function showVersion() {
                var el = document.createElement('div');
                el.id = 'version-display';
                el.style.cssText = 'position:fixed;top:10px;right:10px;font-size:0.7rem;color:rgba(0,0,0,0.7);font-family:"Courier New",monospace;z-index:99999;padding:4px 8px;background:rgba(255,255,255,0.9);border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.2);pointer-events:none;';
                document.body.appendChild(el);
                var apiBase = window.API_BASE || '';
                fetch(apiBase + '/api/version')
                    .then(function(res) { return res.json(); })
                    .then(function(data) {
                        el.textContent = 'v' + data.version + '.' + data.revision;
                        el.title = 'Version ' + data.version + ' (Revision ' + data.revision + ')';
                    })
                    .catch(function() {
                        el.textContent = 'v1.2.0.042';
                    });
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', showVersion);
            } else {
                showVersion();
            }
        })();
    </script>
</head>
<body class="admin-panel">
    <div class="admin-container">
        <div class="admin-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="header-logo">
                    <div class="logo-circle">
                        <span class="logo-text">LJM</span>
                    </div>
                </div>
                <h1>Search Product</h1>
            </div>
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
                <a href="dashboard.html" style="color: white; text-decoration: none;">Dashboard</a>
                <a href="parts.html" style="color: white; text-decoration: none;">Manage Parts</a>
                <a href="setup-instructions.html" style="color: white; text-decoration: none;">Setup Instructions</a>
                <a href="warranties.html" style="color: white; text-decoration: none;">Manage Warranties</a>
                <a href="warranty-pricing.html" style="color: white; text-decoration: none;">Warranty Pricing</a>
                <a href="warranty-terms.html" style="color: white; text-decoration: none;">T&Cs</a>
                <a href="addon-sales.html" style="color: white; text-decoration: none;">Add-On Sales</a>
                <a href="analytics.html" style="color: white; text-decoration: none; font-weight: 600;">üìä Analytics</a>
                <a href="downloads.html" style="color: white; text-decoration: none;">Download Graphics</a>
                <button class="logout-button" id="logoutButton">Logout</button>
            </div>
        </div>

        <div class="search-container">
            <div class="search-form">
                <h2>üîç Search for Product</h2>
                <p style="color: #666; margin-bottom: 20px;">Search by Serial Number, eBay Order Number, or Security Barcode</p>
                
                <form id="searchForm">
                    <div class="form-group">
                        <label for="serialNumber">Serial Number</label>
                        <input type="text" id="serialNumber" name="serial_number" placeholder="Enter serial number">
                    </div>
                    
                    <div class="form-group">
                        <label for="ebayOrderNumber">eBay Order Number</label>
                        <input type="text" id="ebayOrderNumber" name="ebay_order_number" placeholder="Enter eBay order number">
                    </div>
                    
                    <div class="form-group">
                        <label for="securityBarcode">Security Barcode</label>
                        <input type="text" id="securityBarcode" name="security_barcode" placeholder="Enter security barcode">
                    </div>
                    
                    <button type="submit" class="search-button" id="searchButton">Search</button>
                </form>
            </div>

            <div class="error" id="errorMessage"></div>
            <div class="loading" id="loadingMessage">Searching...</div>
            <div class="not-found" id="notFoundMessage">
                <h2>‚ùå Product Not Found</h2>
                <p>No product found matching the search criteria. Please check your input and try again.</p>
            </div>

            <div class="results-container" id="resultsContainer">
                <div class="product-details" id="productDetails"></div>
                <div class="warranty-details" id="warrantyDetails"></div>
            </div>
        </div>
    </div>

    <script src="../js/admin.js"></script>
    <script>
        // Ensure API_BASE is available (from admin.js, but handle if not loaded yet)
        if (typeof window.API_BASE === 'undefined') {
            window.API_BASE = '';
        }
        
        // Check authentication
        if (typeof checkAuth === 'function') {
            checkAuth();
        }
        
        // Search form handler
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const serialNumber = document.getElementById('serialNumber').value.trim();
            const ebayOrderNumber = document.getElementById('ebayOrderNumber').value.trim();
            const securityBarcode = document.getElementById('securityBarcode').value.trim();
            
            if (!serialNumber && !ebayOrderNumber && !securityBarcode) {
                showError('Please enter at least one search criteria');
                return;
            }
            
            // Hide previous results
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('notFoundMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'block';
            
            // Build query string
            const params = new URLSearchParams();
            if (serialNumber) params.append('serial_number', serialNumber);
            if (ebayOrderNumber) params.append('ebay_order_number', ebayOrderNumber);
            if (securityBarcode) params.append('security_barcode', securityBarcode);
            
            try {
                const apiBase = window.API_BASE || '';
                const response = await fetch(`${apiBase}/api/admin/search-product?${params.toString()}`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                document.getElementById('loadingMessage').style.display = 'none';
                
                if (!response.ok) {
                    if (response.status === 404) {
                        document.getElementById('notFoundMessage').style.display = 'block';
                    } else {
                        showError(data.error || 'An error occurred while searching');
                    }
                    return;
                }
                
                // Display results
                displayProduct(data.product);
                displayWarranty(data.warranty);
                document.getElementById('resultsContainer').style.display = 'block';
                
            } catch (error) {
                document.getElementById('loadingMessage').style.display = 'none';
                showError('Network error. Please try again.');
                console.error('Search error:', error);
            }
        });
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        function displayProduct(product) {
            const container = document.getElementById('productDetails');
            
            const formatDate = (date) => {
                if (!date) return 'N/A';
                return new Date(date).toLocaleString();
            };
            
            const formatValue = (value) => {
                if (value === null || value === undefined || value === '') return 'N/A';
                return value;
            };
            
            let photosHtml = '';
            if (product.photos && product.photos.length > 0) {
                photosHtml = '<div class="photo-grid">';
                const apiBase = window.API_BASE || '';
                product.photos.forEach(photo => {
                    // Photos are stored as "/uploads/filename.jpg" or just "filename.jpg"
                    let photoUrl;
                    if (photo.startsWith('http')) {
                        photoUrl = photo;
                    } else if (photo.startsWith('/uploads/')) {
                        // Already has /uploads/ prefix
                        photoUrl = `${apiBase}${photo}`;
                    } else if (photo.startsWith('/')) {
                        // Starts with / but not /uploads/
                        photoUrl = `${apiBase}${photo}`;
                    } else {
                        // Just filename, add /uploads/
                        photoUrl = `${apiBase}/uploads/${photo}`;
                    }
                    photosHtml += `
                        <div class="photo-item">
                            <img src="${photoUrl}" alt="Product photo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'150\' height=\'150\'%3E%3Crect fill=\'%23ddd\' width=\'150\' height=\'150\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3EPhoto%3C/text%3E%3C/svg%3E'">
                        </div>
                    `;
                });
                photosHtml += '</div>';
            }
            
            container.innerHTML = `
                <h2>üì¶ Product Information</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Serial Number</div>
                        <div class="detail-value">${formatValue(product.serial_number)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Security Barcode</div>
                        <div class="detail-value">${formatValue(product.security_barcode)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">eBay Order Number</div>
                        <div class="detail-value ${!product.ebay_order_number ? 'null' : ''}">${formatValue(product.ebay_order_number)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Part Type</div>
                        <div class="detail-value">${formatValue(product.part_type)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Generation</div>
                        <div class="detail-value ${!product.generation ? 'null' : ''}">${formatValue(product.generation)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Part Model Number</div>
                        <div class="detail-value ${!product.part_model_number ? 'null' : ''}">${formatValue(product.part_model_number)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Tracking Number</div>
                        <div class="detail-value ${!product.tracking_number ? 'null' : ''}">${formatValue(product.tracking_number)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Tracking Date</div>
                        <div class="detail-value ${!product.tracking_date ? 'null' : ''}">${formatDate(product.tracking_date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Date Added</div>
                        <div class="detail-value">${formatDate(product.date_added)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Confirmation Checked</div>
                        <div class="detail-value">${product.confirmation_checked ? 'Yes' : 'No'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Confirmation Date</div>
                        <div class="detail-value ${!product.confirmation_date ? 'null' : ''}">${formatDate(product.confirmation_date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Notes</div>
                        <div class="detail-value ${!product.notes ? 'null' : ''}">${formatValue(product.notes)}</div>
                    </div>
                </div>
                ${photosHtml ? `<div style="margin-top: 20px;"><strong>Photos:</strong>${photosHtml}</div>` : ''}
            `;
        }
        
        function displayWarranty(warranty) {
            const container = document.getElementById('warrantyDetails');
            
            if (!warranty) {
                container.innerHTML = `
                    <h2>üõ°Ô∏è Warranty Information</h2>
                    <div class="no-warranty">
                        <h3>No Warranty Registered</h3>
                        <p>This product does not have a registered warranty.</p>
                    </div>
                `;
                return;
            }
            
            const formatDate = (date) => {
                if (!date) return 'N/A';
                return new Date(date).toLocaleString();
            };
            
            const formatValue = (value) => {
                if (value === null || value === undefined || value === '') return 'N/A';
                return value;
            };
            
            const formatCurrency = (amount) => {
                if (amount === null || amount === undefined) return 'N/A';
                return `¬£${parseFloat(amount).toFixed(2)}`;
            };
            
            let addressHtml = '';
            if (warranty.billing_address) {
                const addr = warranty.billing_address;
                addressHtml = `
                    <div class="address-block">
                        ${addr.line1 || ''}<br>
                        ${addr.line2 || ''}<br>
                        ${addr.city || ''}<br>
                        ${addr.postcode || ''}<br>
                        ${addr.country || ''}
                    </div>
                `;
            }
            
            const paymentStatusClass = warranty.payment_status === 'paid' ? 'status-paid' : 'status-free';
            
            container.innerHTML = `
                <h2>üõ°Ô∏è Warranty Information</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Warranty ID</div>
                        <div class="detail-value">${formatValue(warranty.warranty_id)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            <span class="status-badge ${warranty.status === 'active' ? 'status-active' : ''}">${formatValue(warranty.status)}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Customer Name</div>
                        <div class="detail-value">${formatValue(warranty.customer_name)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Customer Email</div>
                        <div class="detail-value">${formatValue(warranty.customer_email)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Customer Phone</div>
                        <div class="detail-value ${!warranty.customer_phone ? 'null' : ''}">${formatValue(warranty.customer_phone)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Extended Warranty</div>
                        <div class="detail-value">${formatValue(warranty.extended_warranty === 'none' ? 'None' : warranty.extended_warranty)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Warranty Price</div>
                        <div class="detail-value">${formatCurrency(warranty.warranty_price)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Payment Status</div>
                        <div class="detail-value">
                            <span class="status-badge ${paymentStatusClass}">${formatValue(warranty.payment_status)}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Payment Intent ID</div>
                        <div class="detail-value ${!warranty.payment_intent_id ? 'null' : ''}">${formatValue(warranty.payment_intent_id)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Marketing Consent</div>
                        <div class="detail-value">${warranty.marketing_consent ? 'Yes' : 'No'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Registration Date</div>
                        <div class="detail-value">${formatDate(warranty.registration_date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Standard Warranty Start</div>
                        <div class="detail-value">${formatDate(warranty.standard_warranty_start)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Standard Warranty End</div>
                        <div class="detail-value">${formatDate(warranty.standard_warranty_end)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Extended Warranty End</div>
                        <div class="detail-value ${!warranty.extended_warranty_end ? 'null' : ''}">${formatDate(warranty.extended_warranty_end)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Terms Version</div>
                        <div class="detail-value">${formatValue(warranty.terms_version)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Terms Accepted</div>
                        <div class="detail-value">${warranty.terms_accepted ? 'Yes' : 'No'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Terms Accepted Date</div>
                        <div class="detail-value ${!warranty.terms_accepted_date ? 'null' : ''}">${formatDate(warranty.terms_accepted_date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Claims Count</div>
                        <div class="detail-value">${formatValue(warranty.claims_count)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Last Claim Date</div>
                        <div class="detail-value ${!warranty.last_claim_date ? 'null' : ''}">${formatDate(warranty.last_claim_date)}</div>
                    </div>
                </div>
                ${addressHtml ? `<div style="margin-top: 20px;"><strong>Billing Address:</strong>${addressHtml}</div>` : ''}
            `;
        }
    </script>
</body>
</html>

