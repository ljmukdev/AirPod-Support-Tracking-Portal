<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Price Snapshot | LJM Admin</title>
    <link rel="stylesheet" href="../css/styles.css?v=1.2.7">
    <link rel="stylesheet" href="../css/ios-mobile-optimizations.css">
    <style>
        .snapshot-controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .snapshot-controls label {
            font-size: 0.9rem;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .snapshot-controls input {
            width: 70px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .snapshot-controls input.budget-input {
            width: 100px;
        }
        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .snapshot-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .snapshot-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .generation-name {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
        }
        .sales-count {
            font-size: 0.75rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .max-bid {
            font-size: 2rem;
            font-weight: 700;
            color: #0d9488;
            margin: 8px 0;
        }
        .max-bid-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 16px;
        }
        .breakdown {
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
            font-size: 0.85rem;
        }
        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            color: #4b5563;
        }
        .breakdown-row.highlight {
            font-weight: 600;
            color: #1f2937;
            border-top: 1px solid #e5e7eb;
            margin-top: 6px;
            padding-top: 6px;
        }
        .breakdown-row .minus { color: #ef4444; }
        .breakdown-row .plus { color: #10b981; }
        .last-sale {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 10px;
        }
        .loading, .error, .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .error { color: #ef4444; }
        .timestamp {
            text-align: center;
            color: #9ca3af;
            font-size: 0.8rem;
            margin-top: 20px;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: #f3f4f6;
            padding: 4px;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background: rgba(255,255,255,0.5);
            color: #374151;
        }
        .tab-btn.active {
            background: white;
            color: #0d9488;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Full Set Cards */
        .parts-breakdown {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #e5e7eb;
        }
        .part-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 0.8rem;
            color: #6b7280;
        }
        .part-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }
        .part-type-badge.left { background: #dbeafe; color: #1d4ed8; }
        .part-type-badge.right { background: #fce7f3; color: #be185d; }
        .part-type-badge.case { background: #d1fae5; color: #047857; }
        .part-missing {
            color: #9ca3af;
            font-style: italic;
        }

        /* Best Sellers Table */
        .sellers-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .sellers-table th,
        .sellers-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .sellers-table th {
            background: #f9fafb;
            font-weight: 600;
            font-size: 0.8rem;
            color: #374151;
            text-transform: uppercase;
        }
        .sellers-table td {
            font-size: 0.9rem;
            color: #4b5563;
        }
        .sellers-table tr:last-child td {
            border-bottom: none;
        }
        .velocity-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .velocity-badge.fast { background: #d1fae5; color: #047857; }
        .velocity-badge.moderate { background: #fef3c7; color: #92400e; }
        .velocity-badge.slow { background: #fee2e2; color: #b91c1c; }
        .velocity-badge.no_sales { background: #f3f4f6; color: #6b7280; }

        /* Investment Optimizer */
        .investment-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-card .label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        .summary-card .value.profit {
            color: #10b981;
        }
        .summary-card .value.investment {
            color: #0d9488;
        }
        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .recommendation-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }
        .recommendation-card .rec-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px 0;
        }
        .recommendation-card .rec-details {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: #6b7280;
        }
        .recommendation-card .rec-details span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .recommendation-card .rec-action {
            text-align: right;
        }
        .recommendation-card .quantity {
            font-size: 2rem;
            font-weight: 700;
            color: #0d9488;
        }
        .recommendation-card .quantity-label {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .priority-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .priority-badge.high { background: #d1fae5; color: #047857; }
        .priority-badge.medium { background: #fef3c7; color: #92400e; }
        .priority-badge.low { background: #f3f4f6; color: #6b7280; }

        /* Price flag badges */
        .price-flag-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .price-flag-badge.realistic { background: #d1fae5; color: #047857; }
        .price-flag-badge.below_historical { background: #fef3c7; color: #92400e; }
        .price-flag-badge.unrealistic { background: #fee2e2; color: #b91c1c; }

        .historical-price-note {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
        }
        .historical-price-note.warning {
            color: #92400e;
        }

        /* Flagged section */
        .flagged-section {
            margin-top: 32px;
            padding: 20px;
            background: #fef2f2;
            border-radius: 12px;
            border: 1px solid #fecaca;
        }
        .flagged-section h4 {
            color: #b91c1c;
            margin: 0 0 16px 0;
            font-size: 1rem;
        }
        .flagged-item {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .flagged-item:last-child {
            margin-bottom: 0;
        }
        .flagged-item .name {
            font-weight: 600;
            color: #1f2937;
        }
        .flagged-item .reason {
            font-size: 0.8rem;
            color: #b91c1c;
        }
        .flagged-item .prices {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Bid Calculator */
        .bid-calculator-form {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .bid-calculator-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .bid-calculator-form label {
            font-size: 0.85rem;
            color: #374151;
            font-weight: 500;
        }
        .bid-calculator-form select {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: 250px;
            background: white;
        }
        .calculator-result {
            margin-top: 24px;
        }
        .calculator-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-width: 500px;
        }
        .calculator-card h3 {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
            color: #1f2937;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .calc-row.indent {
            padding-left: 20px;
            font-size: 0.85rem;
            color: #6b7280;
        }
        .calc-row.subtotal {
            border-top: 1px solid #e5e7eb;
            margin-top: 8px;
            padding-top: 12px;
            font-weight: 600;
            color: #1f2937;
        }
        .calc-row.total {
            border-top: 2px solid #0d9488;
            margin-top: 12px;
            padding-top: 16px;
            font-weight: 700;
            font-size: 1.1rem;
            color: #0d9488;
        }
        .calc-row .minus { color: #ef4444; }
        .calc-row .plus { color: #10b981; }
        .fee-estimate-badge {
            font-size: 0.7rem;
            background: #fef3c7;
            color: #92400e;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            cursor: help;
            vertical-align: middle;
        }
        .calc-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #9ca3af;
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .no-data-part {
            color: #9ca3af;
            font-style: italic;
        }
        .historical-comparison {
            margin-top: 20px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .historical-comparison h4 {
            margin: 0 0 12px 0;
            font-size: 0.9rem;
            color: #374151;
        }
        .historical-comparison .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85rem;
        }
        .historical-comparison .verdict {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }
        .historical-comparison .verdict.good { background: #d1fae5; color: #047857; }
        .historical-comparison .verdict.warning { background: #fef3c7; color: #92400e; }
        .historical-comparison .verdict.bad { background: #fee2e2; color: #b91c1c; }

        /* Mode Selection Panel */
        .mode-selection-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .mode-radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .mode-radio {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-radio:hover {
            border-color: #0d9488;
            background: #f0fdfa;
        }
        .mode-radio:has(input:checked) {
            border-color: #0d9488;
            background: #f0fdfa;
        }
        .mode-radio input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .radio-label {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
            margin-bottom: 4px;
        }
        .radio-description {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .mode-radio:has(input:checked) .radio-label {
            color: #0d9488;
        }

        /* Parts Selection Panel */
        .parts-selection-panel {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .parts-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .parts-checkbox:hover {
            border-color: #0d9488;
        }
        .parts-checkbox:has(input:checked) {
            border-color: #0d9488;
            background: #f0fdfa;
        }
        .parts-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #0d9488;
        }
        .checkbox-label {
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Manual Entry Modal */
        .manual-entry-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .manual-entry-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .manual-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .manual-entry-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #1f2937;
        }
        .close-modal-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .close-modal-btn:hover {
            color: #1f2937;
        }
        .manual-entry-body {
            padding: 20px;
        }
        .manual-entry-instructions {
            margin: 0 0 20px 0;
            color: #4b5563;
            font-size: 0.9rem;
        }
        .manual-prices-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .price-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .price-input-row label {
            width: 60px;
            font-size: 0.9rem;
            color: #374151;
            font-weight: 500;
        }
        .manual-price-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .manual-price-input:focus {
            border-color: #0d9488;
            outline: none;
            box-shadow: 0 0 0 3px rgba(13,148,136,0.1);
        }
        .manual-entry-avg {
            margin-top: 16px;
            padding: 12px;
            background: #f0fdf4;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #166534;
            text-align: center;
        }
        .manual-entry-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* eBay Search Button in Results */
        .ebay-search-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #0d9488;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
        }
        .ebay-search-btn:hover {
            background: #0f766e;
        }
        .enter-manual-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .enter-manual-btn:hover {
            background: #4f46e5;
        }
        .missing-part-card {
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .missing-part-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .missing-part-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .manual-data-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .stale-data-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #f59e0b;
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .saved-data-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #10b981;
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .stale-price-warning {
            animation: pulse-warning 2s infinite;
        }
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        /* Recent Sales Button */
        .load-recent-sales-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .load-recent-sales-btn:hover {
            background: #059669;
        }
        .load-recent-sales-btn:disabled {
            background: #9ca3af;
            cursor: wait;
        }
        .recent-sales-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
        }
        .recent-sales-info {
            margin-top: 12px;
            font-size: 0.85rem;
            color: #047857;
        }
        .recent-sales-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #10b981;
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tab-btn {
                min-width: 80px;
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            .sellers-table {
                display: block;
                overflow-x: auto;
            }
            .recommendation-card {
                grid-template-columns: 1fr;
            }
            .recommendation-card .rec-action {
                text-align: left;
                display: flex;
                gap: 16px;
                align-items: center;
            }
            .mode-radio-group {
                flex-direction: column;
            }
            .mode-radio {
                min-width: 100%;
            }
            .parts-selection-panel {
                flex-direction: column;
            }
            .parts-checkbox {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body class="admin-panel">
    <!-- Sidebar Navigation -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-circle">
                    <span class="logo-text">LJM</span>
                </div>
                <div>
                    <div class="sidebar-logo-text">LJM Admin</div>
                    <div class="sidebar-subtitle">Dashboard</div>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link" data-page="dashboard">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 10L9 4L9 10L17 10M3 10L3 16M3 10L17 10M17 10L17 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item has-submenu">
                        <a href="#" class="nav-link" data-page="inventory" onclick="event.preventDefault(); toggleSubmenu(this.parentElement);">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 5L10 2L17 5M3 5L3 15L10 18M3 5L10 8M17 5L17 15L10 18M17 5L10 8M10 8L10 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Inventory</span>
                        </a>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="products.html" class="nav-link"><span>Products</span></a></li>
                            <li class="nav-item"><a href="parts.html" class="nav-link"><span>Manage Parts</span></a></li>
                            <li class="nav-item"><a href="purchases.html" class="nav-link"><span>Purchases</span></a></li>
                            <li class="nav-item"><a href="check-in.html" class="nav-link"><span>Check-In</span></a></li>
                            <li class="nav-item"><a href="consumables.html" class="nav-link"><span>Consumables</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item has-submenu">
                        <a href="#" class="nav-link" data-page="sales-category" onclick="event.preventDefault(); toggleSubmenu(this.parentElement);">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L5 9L2 12L5 15L8 12L15 5M14 7L17 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="14.5" cy="5.5" r="1.5" fill="currentColor"/>
                            </svg>
                            <span>Sales</span>
                        </a>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="sales.html" class="nav-link"><span>Sales Orders</span></a></li>
                            <li class="nav-item"><a href="addon-sales.html" class="nav-link"><span>Add-On Sales</span></a></li>
                            <li class="nav-item"><a href="returns.html" class="nav-link"><span>Returns</span></a></li>
                            <li class="nav-item"><a href="receipts.html" class="nav-link"><span>Shipping Receipts</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="tasks.html" class="nav-link" data-page="tasks">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 5H7C5.89543 5 5 5.89543 5 7V15C5 16.1046 5.89543 17 7 17H13C14.1046 17 15 16.1046 15 15V7C15 5.89543 14.1046 5 13 5H11M9 5C9 3.89543 9.89543 3 11 3H9C7.89543 3 7 3.89543 7 5M9 5C9 6.10457 9.89543 7 11 7H9C7.89543 7 7 6.10457 7 5M8 10H12M8 13H12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Tasks</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="analytics.html" class="nav-link" data-page="analytics">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 16L3 12M7 16L7 8M11 16L11 10M15 16L15 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="price-recommender.html" class="nav-link active" data-page="price-recommender">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 2C10 2 10 5 10 7M10 7C8 7 6 8 6 10C6 12 8 13 10 13C12 13 14 12 14 10C14 8 12 7 10 7ZM10 13V18M6 18H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Price Snapshot</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="ebay-import.html" class="nav-link" data-page="ebay-import">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 3V13M10 13L6 9M10 13L14 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M3 17H17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            <span>eBay Import</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="sidebar-footer">
            <a href="downloads.html" class="sidebar-footer-link">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 3V13M10 13L6 9M10 13L14 9M3 17H17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Downloads</span>
            </a>
            <button class="sidebar-footer-link sidebar-logout" id="logoutButton">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 15L17 10L13 5M17 10H7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 3H4C3.44772 3 3 3.44772 3 4V16C3 16.5523 3.44772 17 4 17H7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="admin-main">
        <header class="admin-topbar">
            <div class="topbar-left">
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 5H17M3 10H17M3 15H17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
                <h1 class="page-title">Max Bid Calculator</h1>
            </div>
            <div class="topbar-right">
                <div class="topbar-user">
                    <span class="topbar-user-name">Admin</span>
                </div>
            </div>
        </header>

        <div class="admin-content">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="bid-calc">Bid Calculator</button>
                <button class="tab-btn" data-tab="individual">Individual Parts</button>
                <button class="tab-btn" data-tab="full-sets">Full Sets</button>
                <button class="tab-btn" data-tab="best-sellers">Best Sellers</button>
                <button class="tab-btn" data-tab="investment">Investment Optimizer</button>
            </div>

            <!-- Bid Calculator Tab -->
            <div class="tab-content active" id="tab-bid-calc">
                <div class="snapshot-controls">
                    <div class="bid-calculator-form">
                        <div class="form-group">
                            <label>Select AirPods Generation</label>
                            <select id="bidCalcGeneration" onchange="onGenerationChange()">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Min Profit Target</label>
                            <input type="number" id="bidCalcProfit" value="10" min="0" step="1" style="width:80px;padding:10px 14px;border:1px solid #d1d5db;border-radius:6px;">
                        </div>
                        <div class="form-group">
                            <label>Postage Charged</label>
                            <input type="number" id="bidCalcPostage" value="0" min="0" step="0.01" placeholder="0.00" style="width:80px;padding:10px 14px;border:1px solid #d1d5db;border-radius:6px;">
                        </div>
                    </div>
                </div>

                <!-- Calculation Mode Selection -->
                <div class="mode-selection-panel" id="modeSelectionPanel" style="display:none;">
                    <div class="mode-radio-group">
                        <label class="mode-radio">
                            <input type="radio" name="calcMode" value="full-set" checked onchange="onModeChange()">
                            <span class="radio-label">Full Set</span>
                            <span class="radio-description">Calculate max bid for complete set (Left + Right + Case)</span>
                        </label>
                        <label class="mode-radio">
                            <input type="radio" name="calcMode" value="individual-parts" onchange="onModeChange()">
                            <span class="radio-label">Individual Parts</span>
                            <span class="radio-description">Select specific parts to calculate max bid</span>
                        </label>
                    </div>

                    <!-- Parts Selection (shown when Individual Parts is selected) -->
                    <div class="parts-selection-panel" id="partsSelectionPanel" style="display:none;">
                        <label class="parts-checkbox">
                            <input type="checkbox" id="partLeft" value="left" checked onchange="onPartSelectionChange()">
                            <span class="checkbox-label part-type-badge left">Left Earbud</span>
                        </label>
                        <label class="parts-checkbox">
                            <input type="checkbox" id="partRight" value="right" checked onchange="onPartSelectionChange()">
                            <span class="checkbox-label part-type-badge right">Right Earbud</span>
                        </label>
                        <label class="parts-checkbox">
                            <input type="checkbox" id="partCase" value="case" checked onchange="onPartSelectionChange()">
                            <span class="checkbox-label part-type-badge case">Charging Case</span>
                        </label>
                    </div>

                    <button class="btn btn-primary" onclick="calculateBid()" style="margin-top:16px;">Calculate Max Bid</button>
                </div>

                <div id="bidCalcResult">
                    <div class="no-data" style="padding:40px 20px;"><p>Select a set above to calculate the max bid price.</p></div>
                </div>

                <!-- Manual Data Entry Modal -->
                <div class="manual-entry-modal" id="manualEntryModal" style="display:none;">
                    <div class="manual-entry-content">
                        <div class="manual-entry-header">
                            <h3>Enter eBay Sold Listings Data</h3>
                            <button class="close-modal-btn" onclick="closeManualEntryModal()">&times;</button>
                        </div>
                        <div class="manual-entry-body">
                            <p class="manual-entry-instructions">
                                Enter the 5 most recent sold prices from eBay completed listings for <strong id="manualEntryPartName"></strong>.
                                <br><small>Prices should be the final sold price including shipping.</small>
                            </p>
                            <div class="manual-prices-grid">
                                <div class="price-input-row">
                                    <label>Sale 1:</label>
                                    <input type="number" class="manual-price-input" id="manualPrice1" placeholder="0.00" step="0.01" min="0">
                                </div>
                                <div class="price-input-row">
                                    <label>Sale 2:</label>
                                    <input type="number" class="manual-price-input" id="manualPrice2" placeholder="0.00" step="0.01" min="0">
                                </div>
                                <div class="price-input-row">
                                    <label>Sale 3:</label>
                                    <input type="number" class="manual-price-input" id="manualPrice3" placeholder="0.00" step="0.01" min="0">
                                </div>
                                <div class="price-input-row">
                                    <label>Sale 4:</label>
                                    <input type="number" class="manual-price-input" id="manualPrice4" placeholder="0.00" step="0.01" min="0">
                                </div>
                                <div class="price-input-row">
                                    <label>Sale 5:</label>
                                    <input type="number" class="manual-price-input" id="manualPrice5" placeholder="0.00" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="manual-entry-avg" id="manualEntryAvg">
                                Average: <strong>-</strong>
                            </div>
                            <div class="manual-entry-actions">
                                <button class="btn btn-secondary" onclick="closeManualEntryModal()">Cancel</button>
                                <button class="btn btn-primary" onclick="applyManualData()">Apply & Calculate</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Individual Parts Tab -->
            <div class="tab-content" id="tab-individual">
                <div class="snapshot-controls">
                    <label>Min Profit: £<input type="number" id="minProfit" value="10" min="0" step="1"></label>
                    <label>Last <input type="number" id="salesCount" value="5" min="1" max="50"> sales</label>
                    <button class="btn btn-primary" id="refreshBtn" onclick="loadSnapshot()">Refresh</button>
                </div>
                <div id="snapshotContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Full Sets Tab -->
            <div class="tab-content" id="tab-full-sets">
                <div class="snapshot-controls">
                    <label>Min Profit: £<input type="number" id="minProfitSets" value="10" min="0" step="1"></label>
                    <label>Last <input type="number" id="salesCountSets" value="10" min="1" max="50"> sales per part</label>
                    <button class="btn btn-primary" id="refreshBtnSets" onclick="loadFullSets()">Refresh</button>
                </div>
                <div id="fullSetsContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Best Sellers Tab -->
            <div class="tab-content" id="tab-best-sellers">
                <div class="snapshot-controls">
                    <label>Last <input type="number" id="daysBestSellers" value="30" min="1" max="365"> days</label>
                    <button class="btn btn-primary" id="refreshBtnSellers" onclick="loadBestSellers()">Refresh</button>
                </div>
                <div id="bestSellersContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Investment Optimizer Tab -->
            <div class="tab-content" id="tab-investment">
                <div class="snapshot-controls">
                    <label>Budget: £<input type="number" id="investmentBudget" value="500" min="0" step="50" class="budget-input"></label>
                    <label>Min Profit: £<input type="number" id="minProfitInvest" value="10" min="0" step="1"></label>
                    <label>Last <input type="number" id="daysInvest" value="30" min="1" max="365"> days</label>
                    <button class="btn btn-primary" id="refreshBtnInvest" onclick="loadInvestmentOptimizer()">Calculate</button>
                </div>
                <div id="investmentContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="timestamp" id="timestamp"></div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <script src="../js/admin.js?v=1.0.6"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.dataset.tab;

                // Update active button
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Update active content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${tabId}`).classList.add('active');

                // Load data for the tab if not loaded
                if (tabId === 'full-sets' && !window.fullSetsLoaded) {
                    loadFullSets();
                } else if (tabId === 'best-sellers' && !window.bestSellersLoaded) {
                    loadBestSellers();
                } else if (tabId === 'investment' && !window.investmentLoaded) {
                    loadInvestmentOptimizer();
                }
            });
        });

        // Individual Parts Snapshot (existing functionality)
        async function loadSnapshot() {
            const content = document.getElementById('snapshotContent');
            const refreshBtn = document.getElementById('refreshBtn');
            const minProfitEl = document.getElementById('minProfit');
            const salesCountEl = document.getElementById('salesCount');

            if (!content) return;

            const minProfit = minProfitEl ? minProfitEl.value : 10;
            const salesCount = salesCountEl ? salesCountEl.value : 5;

            content.innerHTML = '<div class="loading">Loading...</div>';
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
            }

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                const response = await authenticatedFetch(
                    `/api/admin/price-snapshot?min_profit=${minProfit}&sales_count=${salesCount}`
                );

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to load');
                }

                const data = await response.json();

                if (!data.snapshot || data.snapshot.length === 0) {
                    content.innerHTML = '<div class="no-data"><p>No sales data found.</p><p style="font-size:0.9rem">Record some sales to see max bid recommendations.</p></div>';
                    return;
                }

                content.innerHTML = '<div class="snapshot-grid">' + data.snapshot.map(item => `
                    <div class="snapshot-card">
                        <div class="snapshot-card-header">
                            <span class="generation-name">${item.generation}</span>
                            <span class="sales-count">${item.sales_analyzed} sales</span>
                        </div>
                        <div class="max-bid">£${item.max_bid.toFixed(2)}</div>
                        <div class="max-bid-label">Max bid for £${minProfit} profit</div>
                        <div class="breakdown">
                            <div class="breakdown-row"><span>Avg Sale</span><span>£${item.avg_sale_price.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Fees</span><span class="minus">-£${item.avg_fees.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Consumables</span><span class="minus">-£${item.avg_consumables.toFixed(2)}</span></div>
                            <div class="breakdown-row highlight"><span>Net</span><span>£${item.avg_net_revenue.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Profit</span><span class="minus">-£${item.min_profit.toFixed(2)}</span></div>
                            <div class="breakdown-row highlight"><span>Max Bid</span><span style="color:#0d9488">£${item.max_bid.toFixed(2)}</span></div>
                        </div>
                        ${item.last_sale_date ? `<div class="last-sale">Last: ${new Date(item.last_sale_date).toLocaleDateString()}</div>` : ''}
                    </div>
                `).join('') + '</div>';

                document.getElementById('timestamp').textContent = 'Generated: ' + new Date(data.generated_at).toLocaleString();

            } catch (err) {
                content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh';
                }
            }
        }

        // Full Sets Calculator
        async function loadFullSets() {
            const content = document.getElementById('fullSetsContent');
            const refreshBtn = document.getElementById('refreshBtnSets');
            const minProfitEl = document.getElementById('minProfitSets');
            const salesCountEl = document.getElementById('salesCountSets');

            if (!content) return;

            const minProfit = minProfitEl ? minProfitEl.value : 10;
            const salesCount = salesCountEl ? salesCountEl.value : 10;

            content.innerHTML = '<div class="loading">Loading...</div>';
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
            }

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                const response = await authenticatedFetch(
                    `/api/admin/price-snapshot/full-sets?min_profit=${minProfit}&sales_count=${salesCount}`
                );

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to load');
                }

                const data = await response.json();
                window.fullSetsLoaded = true;

                if (!data.full_sets || data.full_sets.length === 0) {
                    content.innerHTML = '<div class="no-data"><p>No full set data found.</p><p style="font-size:0.9rem">Need sales of individual parts (left, right, case) to calculate full set bids.</p></div>';
                    return;
                }

                content.innerHTML = '<div class="snapshot-grid">' + data.full_sets.map(item => `
                    <div class="snapshot-card">
                        <div class="snapshot-card-header">
                            <span class="generation-name">${item.generation}</span>
                            <span class="sales-count">${item.has_all_parts ? 'All parts' : item.parts_with_data + '/3 parts'}</span>
                        </div>
                        <div class="max-bid">£${item.full_set_max_bid.toFixed(2)}</div>
                        <div class="max-bid-label">Full set max bid for £${minProfit} profit</div>
                        <div class="breakdown">
                            <div class="breakdown-row"><span>Combined Sale Value</span><span>£${item.combined_sale_price.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Total Fees</span><span class="minus">-£${item.combined_fees.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Total Consumables</span><span class="minus">-£${item.combined_consumables.toFixed(2)}</span></div>
                            <div class="breakdown-row highlight"><span>Net Revenue</span><span>£${item.combined_net_revenue.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Min Profit</span><span class="minus">-£${item.min_profit.toFixed(2)}</span></div>
                            <div class="breakdown-row highlight"><span>Full Set Max Bid</span><span style="color:#0d9488">£${item.full_set_max_bid.toFixed(2)}</span></div>
                        </div>
                        <div class="parts-breakdown">
                            <div style="font-size:0.75rem;color:#6b7280;margin-bottom:8px;">Parts breakdown:</div>
                            ${['left', 'right', 'case'].map(partType => {
                                const part = item.parts_breakdown[partType];
                                if (part) {
                                    return `<div class="part-row">
                                        <span class="part-type-badge ${partType}">${partType}</span>
                                        <span>£${part.avg_sale_price.toFixed(2)} (${part.sales_analyzed} sales)</span>
                                    </div>`;
                                } else {
                                    return `<div class="part-row">
                                        <span class="part-type-badge ${partType}">${partType}</span>
                                        <span class="part-missing">No data</span>
                                    </div>`;
                                }
                            }).join('')}
                        </div>
                    </div>
                `).join('') + '</div>';

                document.getElementById('timestamp').textContent = 'Generated: ' + new Date(data.generated_at).toLocaleString();

            } catch (err) {
                content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh';
                }
            }
        }

        // Best Sellers Analysis
        async function loadBestSellers() {
            const content = document.getElementById('bestSellersContent');
            const refreshBtn = document.getElementById('refreshBtnSellers');
            const daysEl = document.getElementById('daysBestSellers');

            if (!content) return;

            const days = daysEl ? daysEl.value : 30;

            content.innerHTML = '<div class="loading">Loading...</div>';
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
            }

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                const response = await authenticatedFetch(
                    `/api/admin/price-snapshot/best-sellers?days=${days}`
                );

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to load');
                }

                const data = await response.json();
                window.bestSellersLoaded = true;

                if (!data.best_sellers || data.best_sellers.length === 0) {
                    content.innerHTML = '<div class="no-data"><p>No best seller data found.</p><p style="font-size:0.9rem">Need stock and sales data to analyze best sellers.</p></div>';
                    return;
                }

                content.innerHTML = `
                    <div class="sellers-table-wrapper" style="overflow-x:auto;">
                        <table class="sellers-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Generation</th>
                                    <th>Part</th>
                                    <th>Stock</th>
                                    <th>Sales (${days}d)</th>
                                    <th>Velocity/Day</th>
                                    <th>Days of Stock</th>
                                    <th>Avg Price</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.best_sellers.map(item => `
                                    <tr>
                                        <td><strong>#${item.rank}</strong></td>
                                        <td>${item.generation || 'Unknown'}</td>
                                        <td><span class="part-type-badge ${item.part_type}">${item.part_type || 'N/A'}</span></td>
                                        <td>${item.current_stock}</td>
                                        <td>${item.sales_count}</td>
                                        <td>${item.sales_velocity.toFixed(2)}</td>
                                        <td>${item.days_of_stock !== null ? item.days_of_stock + ' days' : '-'}</td>
                                        <td>£${item.avg_sale_price.toFixed(2)}</td>
                                        <td><span class="velocity-badge ${item.seller_category}">${item.seller_category.replace('_', ' ')}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('timestamp').textContent = 'Generated: ' + new Date(data.generated_at).toLocaleString();

            } catch (err) {
                content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh';
                }
            }
        }

        // Investment Optimizer
        async function loadInvestmentOptimizer() {
            const content = document.getElementById('investmentContent');
            const refreshBtn = document.getElementById('refreshBtnInvest');
            const budgetEl = document.getElementById('investmentBudget');
            const minProfitEl = document.getElementById('minProfitInvest');
            const daysEl = document.getElementById('daysInvest');

            if (!content) return;

            const budget = budgetEl ? budgetEl.value : 500;
            const minProfit = minProfitEl ? minProfitEl.value : 10;
            const days = daysEl ? daysEl.value : 30;

            content.innerHTML = '<div class="loading">Calculating optimal investments...</div>';
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Calculating...';
            }

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                const response = await authenticatedFetch(
                    `/api/admin/price-snapshot/investment-optimizer?budget=${budget}&min_profit=${minProfit}&days=${days}`
                );

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to load');
                }

                const data = await response.json();
                window.investmentLoaded = true;

                if (!data.recommendations || data.recommendations.length === 0) {
                    // Check if there are flagged items
                    if (data.flagged_unrealistic && data.flagged_unrealistic.length > 0) {
                        content.innerHTML = `
                            <div class="no-data"><p>No realistic investment recommendations.</p><p style="font-size:0.9rem">All sets have unrealistic calculated prices based on historical purchase data.</p></div>
                            <div class="flagged-section">
                                <h4>Excluded Sets (Unrealistic Prices)</h4>
                                ${data.flagged_unrealistic.map(item => `
                                    <div class="flagged-item">
                                        <div>
                                            <div class="name">${item.generation}</div>
                                            <div class="reason">${item.price_flag_reason}</div>
                                        </div>
                                        <div class="prices">
                                            Calculated: £${item.calculated_max_bid.toFixed(2)} | Historical: £${item.historical_purchase_price ? item.historical_purchase_price.toFixed(2) : 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        content.innerHTML = '<div class="no-data"><p>No investment recommendations.</p><p style="font-size:0.9rem">Need more sales data or increase budget to generate recommendations.</p></div>';
                    }
                    return;
                }

                const summary = data.summary;

                // Build historical price note helper
                const getHistoricalNote = (rec) => {
                    if (!rec.historical_purchase_price) return '';
                    if (rec.price_flag === 'below_historical') {
                        return `<div class="historical-price-note warning">Historical avg: £${rec.historical_purchase_price.toFixed(2)}</div>`;
                    }
                    return `<div class="historical-price-note">Historical avg: £${rec.historical_purchase_price.toFixed(2)}</div>`;
                };

                // Build price flag badge helper
                const getPriceFlagBadge = (rec) => {
                    if (!rec.price_flag || rec.price_flag === 'realistic') return '';
                    if (rec.price_flag === 'below_historical') {
                        return `<span class="price-flag-badge below_historical">Below avg</span>`;
                    }
                    return '';
                };

                content.innerHTML = `
                    <div class="investment-summary">
                        <div class="summary-card">
                            <div class="label">Budget</div>
                            <div class="value">£${data.budget.toFixed(2)}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Total Investment</div>
                            <div class="value investment">£${summary.total_investment.toFixed(2)}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Expected Profit</div>
                            <div class="value profit">£${summary.total_expected_profit.toFixed(2)}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">ROI</div>
                            <div class="value">${summary.overall_roi_percentage.toFixed(1)}%</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Sets to Buy</div>
                            <div class="value">${summary.total_sets_recommended}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Remaining</div>
                            <div class="value">£${summary.remaining_budget.toFixed(2)}</div>
                        </div>
                    </div>

                    <h3 style="margin:24px 0 16px;color:#1f2937;">Purchase Recommendations</h3>
                    <div class="recommendations-list">
                        ${data.recommendations.map((rec, index) => {
                            const priority = index < 2 ? 'high' : index < 4 ? 'medium' : 'low';
                            return `
                            <div class="recommendation-card">
                                <div class="rec-info">
                                    <h3>
                                        ${rec.generation}
                                        <span class="priority-badge ${priority}">${priority} priority</span>
                                        ${getPriceFlagBadge(rec)}
                                    </h3>
                                    <div class="rec-details">
                                        <span>£${rec.cost_per_set.toFixed(2)} per set</span>
                                        <span>£${rec.expected_profit_per_set.toFixed(2)} profit each</span>
                                        <span>${rec.roi_percentage.toFixed(1)}% ROI</span>
                                        <span>${rec.sales_velocity.toFixed(2)} sales/day</span>
                                    </div>
                                    ${getHistoricalNote(rec)}
                                </div>
                                <div class="rec-action">
                                    <div class="quantity">${rec.recommended_quantity}</div>
                                    <div class="quantity-label">sets</div>
                                    <div style="font-size:0.8rem;color:#6b7280;margin-top:4px;">£${rec.total_cost.toFixed(2)} total</div>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>

                    ${data.flagged_unrealistic && data.flagged_unrealistic.length > 0 ? `
                        <div class="flagged-section">
                            <h4>Excluded Sets (Unrealistic Prices - >10% below historical avg)</h4>
                            ${data.flagged_unrealistic.map(item => `
                                <div class="flagged-item">
                                    <div>
                                        <div class="name">${item.generation}</div>
                                        <div class="reason">${item.price_flag_reason}</div>
                                    </div>
                                    <div class="prices">
                                        Calculated: £${item.calculated_max_bid.toFixed(2)} | Historical: £${item.historical_purchase_price ? item.historical_purchase_price.toFixed(2) : 'N/A'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;

                document.getElementById('timestamp').textContent = 'Generated: ' + new Date(data.generated_at).toLocaleString();

            } catch (err) {
                content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Calculate';
                }
            }
        }

        // Bid Calculator State
        let manualPriceData = {};
        let currentManualEntryPart = null;
        let currentSelection = null;

        // Bid Calculator - Load generation options (ALL generations, not just those with sales data)
        async function loadBidCalcOptions() {
            const select = document.getElementById('bidCalcGeneration');
            if (!select) return;

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                // Get ALL unique generation + connector_type combinations from products
                const response = await authenticatedFetch('/api/admin/price-snapshot/all-generations');
                if (!response.ok) {
                    throw new Error('Failed to load options');
                }

                const data = await response.json();

                select.innerHTML = '<option value="">-- Select AirPods Generation --</option>';

                if (data.generations && data.generations.length > 0) {
                    for (const gen of data.generations) {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({
                            generation: gen.generation,
                            connector_type: gen.connector_type
                        });
                        option.textContent = gen.display_name;
                        select.appendChild(option);
                    }
                } else {
                    select.innerHTML = '<option value="">No products found</option>';
                }

            } catch (err) {
                select.innerHTML = '<option value="">Error loading options</option>';
                console.error('Error loading bid calc options:', err);
            }
        }

        // Show/hide mode selection panel when generation is selected
        function onGenerationChange() {
            const select = document.getElementById('bidCalcGeneration');
            const modePanel = document.getElementById('modeSelectionPanel');
            const resultDiv = document.getElementById('bidCalcResult');

            if (select && select.value) {
                currentSelection = JSON.parse(select.value);
                modePanel.style.display = 'block';
                // Reset manual price data for new selection
                manualPriceData = {};
                resultDiv.innerHTML = '<div class="no-data" style="padding:40px 20px;"><p>Select options above and click Calculate.</p></div>';
            } else {
                modePanel.style.display = 'none';
                resultDiv.innerHTML = '<div class="no-data" style="padding:40px 20px;"><p>Select a set above to calculate the max bid price.</p></div>';
            }
        }

        // Toggle between full set and individual parts mode
        function onModeChange() {
            const mode = document.querySelector('input[name="calcMode"]:checked')?.value;
            const partsPanel = document.getElementById('partsSelectionPanel');

            if (mode === 'individual-parts') {
                partsPanel.style.display = 'flex';
            } else {
                partsPanel.style.display = 'none';
                // Reset all checkboxes to checked
                document.getElementById('partLeft').checked = true;
                document.getElementById('partRight').checked = true;
                document.getElementById('partCase').checked = true;
            }
        }

        // Get selected parts
        function getSelectedParts() {
            const mode = document.querySelector('input[name="calcMode"]:checked')?.value;
            if (mode === 'full-set') {
                return ['left', 'right', 'case'];
            }
            const parts = [];
            if (document.getElementById('partLeft').checked) parts.push('left');
            if (document.getElementById('partRight').checked) parts.push('right');
            if (document.getElementById('partCase').checked) parts.push('case');
            return parts;
        }

        // Handle part selection changes
        function onPartSelectionChange() {
            const parts = getSelectedParts();
            if (parts.length === 0) {
                // Prevent deselecting all parts
                alert('Please select at least one part.');
                event.target.checked = true;
            }
        }

        // Open manual entry modal for a specific part
        function openManualEntryModal(partType, partName, searchQuery, ebayUrl) {
            const modal = document.getElementById('manualEntryModal');
            const partNameEl = document.getElementById('manualEntryPartName');

            currentManualEntryPart = {
                partType,
                partName,
                searchQuery,
                ebayUrl
            };

            partNameEl.innerHTML = `<span class="part-type-badge ${partType}">${partType}</span> ${partName}`;

            // Clear previous values
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`manualPrice${i}`).value = '';
            }

            // If we have existing manual data for this part, populate it
            if (manualPriceData[partType] && manualPriceData[partType].prices) {
                manualPriceData[partType].prices.forEach((price, index) => {
                    if (index < 5) {
                        document.getElementById(`manualPrice${index + 1}`).value = price;
                    }
                });
            }

            updateManualAverage();
            modal.style.display = 'flex';

            // Add event listeners to update average
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`manualPrice${i}`).addEventListener('input', updateManualAverage);
            }
        }

        // Close manual entry modal
        function closeManualEntryModal() {
            const modal = document.getElementById('manualEntryModal');
            modal.style.display = 'none';
            currentManualEntryPart = null;
        }

        // Update manual entry average calculation
        function updateManualAverage() {
            const prices = [];
            for (let i = 1; i <= 5; i++) {
                const val = parseFloat(document.getElementById(`manualPrice${i}`).value);
                if (!isNaN(val) && val > 0) {
                    prices.push(val);
                }
            }

            const avgEl = document.getElementById('manualEntryAvg');
            if (prices.length > 0) {
                const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
                avgEl.innerHTML = `Average (${prices.length} prices): <strong>£${avg.toFixed(2)}</strong>`;
            } else {
                avgEl.innerHTML = 'Average: <strong>-</strong>';
            }
        }

        // Apply manual data and recalculate
        async function applyManualData() {
            if (!currentManualEntryPart) return;

            const prices = [];
            for (let i = 1; i <= 5; i++) {
                const val = parseFloat(document.getElementById(`manualPrice${i}`).value);
                if (!isNaN(val) && val > 0) {
                    prices.push(val);
                }
            }

            if (prices.length === 0) {
                alert('Please enter at least one price.');
                return;
            }

            const avg = prices.reduce((a, b) => a + b, 0) / prices.length;

            manualPriceData[currentManualEntryPart.partType] = {
                avg_sale_price: avg,
                prices: prices,
                is_manual: true,
                sales_count: prices.length
            };

            // Save to database for persistence
            if (currentSelection) {
                try {
                    await authenticatedFetch('/api/admin/price-snapshot/manual-prices', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            generation: currentSelection.generation,
                            connector_type: currentSelection.connector_type || null,
                            part_type: currentManualEntryPart.partType,
                            prices: prices
                        })
                    });
                } catch (err) {
                    console.error('Failed to save manual prices:', err);
                    // Continue anyway - prices are stored locally
                }
            }

            closeManualEntryModal();
            calculateBid();
        }

        // Bid Calculator - Calculate max bid for selected set
        async function calculateBid() {
            const select = document.getElementById('bidCalcGeneration');
            const profitInput = document.getElementById('bidCalcProfit');
            const postageInput = document.getElementById('bidCalcPostage');
            const resultDiv = document.getElementById('bidCalcResult');

            if (!select || !select.value) {
                resultDiv.innerHTML = '<div class="no-data" style="padding:40px 20px;"><p>Please select a set first.</p></div>';
                return;
            }

            const minProfit = parseFloat(profitInput?.value) || 10;
            const postageCharged = parseFloat(postageInput?.value) || 0;
            const selection = JSON.parse(select.value);
            const selectedParts = getSelectedParts();

            if (selectedParts.length === 0) {
                resultDiv.innerHTML = '<div class="no-data" style="padding:40px 20px;"><p>Please select at least one part.</p></div>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading">Calculating...</div>';

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                // Fetch the calculation for this specific set with selected parts
                const params = new URLSearchParams({
                    generation: selection.generation,
                    connector_type: selection.connector_type || '',
                    min_profit: minProfit,
                    postage_charged: postageCharged,
                    parts: selectedParts.join(',')
                });

                // Add manual data if available
                if (Object.keys(manualPriceData).length > 0) {
                    params.append('manual_data', JSON.stringify(manualPriceData));
                }

                const response = await authenticatedFetch(`/api/admin/price-snapshot/bid-calculator?${params}`);
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to calculate');
                }

                const data = await response.json();

                // Build display name for selected parts
                const partsDisplayName = selectedParts.length === 3 ? 'Full Set' :
                    selectedParts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' + ');

                if (!data.success) {
                    // Show missing parts with eBay search and manual entry options
                    if (data.needs_manual_data && data.missing_parts) {
                        let partialDataHtml = '';
                        const partsWithData = selectedParts.filter(pt => data.partial_data && data.partial_data[pt]);

                        // Build stale warning for partial data section
                        let staleWarningHtml = '';
                        if (data.has_stale_prices && data.stale_parts_warning && data.stale_parts_warning.length > 0) {
                            const staleInPartialData = data.stale_parts_warning.filter(s => partsWithData.includes(s.part_type));
                            if (staleInPartialData.length > 0) {
                                staleWarningHtml = `
                                    <div style="margin-bottom:20px;padding:12px;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;">
                                        <p style="margin:0;color:#92400e;font-size:0.85rem;">
                                            <strong>⚠️ Note:</strong> Some saved prices are older than 3 days. Consider refreshing them for accuracy.
                                        </p>
                                    </div>
                                `;
                            }
                        }

                        if (partsWithData.length > 0) {
                            partialDataHtml = `
                                ${staleWarningHtml}
                                <div style="margin-bottom:20px;">
                                    <h4 style="margin:0 0 12px;color:#374151;">Available Data:</h4>
                                    ${partsWithData.map(partType => {
                                        const part = data.partial_data[partType];
                                        const isManual = manualPriceData[partType]?.is_manual || part?.is_manual;
                                        const isSaved = part?.is_saved;
                                        const isStale = part?.is_stale;
                                        const daysSinceUpdate = part?.days_since_update;
                                        if (part) {
                                            let badge = '';
                                            let bgColor = '#d1fae5';
                                            if (isStale) {
                                                badge = `<span style="background:#f59e0b;color:white;font-size:0.7rem;padding:2px 6px;border-radius:3px;margin-left:8px;">Stale (${daysSinceUpdate}d)</span>`;
                                                bgColor = '#fef3c7';
                                            } else if (isSaved) {
                                                badge = '<span style="background:#10b981;color:white;font-size:0.7rem;padding:2px 6px;border-radius:3px;margin-left:8px;">Saved</span>';
                                            } else if (isManual) {
                                                badge = '<span class="manual-data-badge">Manual</span>';
                                            }
                                            return `<div class="part-row" style="padding:8px 12px;background:${bgColor};border-radius:6px;margin-bottom:4px;">
                                                <span class="part-type-badge ${partType}">${partType}</span>
                                                <span style="color:#047857;font-weight:600;">£${part.avg_sale_price.toFixed(2)} avg (${part.sales_count} ${isManual || isSaved ? 'manual entries' : 'sales'})</span>
                                                ${badge}
                                            </div>`;
                                        }
                                        return '';
                                    }).join('')}
                                </div>
                            `;
                        }

                        const missingParts = data.missing_parts.filter(pt => selectedParts.includes(pt));

                        resultDiv.innerHTML = `
                            <div class="calculator-card" style="max-width:700px;">
                                <h3>${data.display_name} - ${partsDisplayName}</h3>
                                <div style="padding:16px;background:#fef3c7;border-radius:8px;margin-bottom:20px;">
                                    <p style="margin:0 0 8px;color:#92400e;font-weight:600;">
                                        Missing Data: ${missingParts.length} of ${selectedParts.length} selected parts need data
                                    </p>
                                    <p style="margin:0;color:#92400e;font-size:0.9rem;">
                                        Use your recent sales data or search eBay completed listings.
                                    </p>
                                </div>

                                <!-- Recent Sales Quick Load Section -->
                                <div class="recent-sales-section">
                                    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
                                        <div>
                                            <strong style="color:#047857;">Quick Option: Use Your Recent Sales</strong>
                                            <p style="margin:4px 0 0;font-size:0.85rem;color:#059669;">
                                                Load prices from your last 5 sales for each part type.
                                            </p>
                                        </div>
                                        <button class="load-recent-sales-btn" id="loadRecentSalesBtn" onclick="loadRecentSales()">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2 8C2 4.68629 4.68629 2 8 2C10.0503 2 11.8574 3.00442 12.9554 4.54404M14 8C14 11.3137 11.3137 14 8 14C5.94972 14 4.14265 12.9956 3.04464 11.456" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                                <path d="M12.9554 4.54404L13.5 2.5M12.9554 4.54404L10.9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            Load Recent Sales
                                        </button>
                                    </div>
                                    <div id="recentSalesStatus" style="display:none;margin-top:12px;"></div>
                                </div>

                                ${partialDataHtml}
                                <div>
                                    <h4 style="margin:0 0 12px;color:#374151;">Or Enter Prices Manually:</h4>
                                    ${missingParts.map(partType => {
                                        const suggestion = data.ebay_search_suggestions?.find(s => s.part_type === partType);
                                        const searchQuery = suggestion?.search_query || `${selection.generation} ${partType}`;
                                        const ebayUrl = suggestion?.ebay_url || `https://www.ebay.co.uk/sch/i.html?_nkw=${encodeURIComponent(searchQuery)}&LH_Complete=1&LH_Sold=1`;
                                        return `
                                            <div class="missing-part-card">
                                                <div class="missing-part-info">
                                                    <div>
                                                        <span class="part-type-badge ${partType}">${partType}</span>
                                                        <span style="margin-left:8px;color:#6b7280;font-size:0.85rem;">${searchQuery}</span>
                                                    </div>
                                                </div>
                                                <div class="missing-part-actions">
                                                    <a href="${ebayUrl}" target="_blank" rel="noopener" class="ebay-search-btn">
                                                        Search eBay Sold Listings
                                                    </a>
                                                    <button class="enter-manual-btn" onclick="openManualEntryModal('${partType}', '${searchQuery}', '${searchQuery}', '${ebayUrl}')">
                                                        Enter 5 Sales Prices
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <div style="margin-top:20px;padding:16px;background:#f0f9ff;border-radius:8px;">
                                    <p style="margin:0;font-size:0.85rem;color:#0369a1;">
                                        <strong>How to use:</strong> Click "Search eBay Sold Listings" to find recent sold prices, then click "Enter 5 Sales Prices" to input them. The calculator will use the average of your entered prices.
                                    </p>
                                </div>
                            </div>
                        `;
                        return;
                    }

                    resultDiv.innerHTML = `<div class="no-data" style="padding:40px 20px;"><p>${data.error || 'Unable to calculate bid.'}</p></div>`;
                    return;
                }

                const calc = data.calculation;

                // Build stale price warning HTML
                let stalePriceWarningHtml = '';
                if (data.has_stale_prices && data.stale_parts_warning && data.stale_parts_warning.length > 0) {
                    const stalePartsList = data.stale_parts_warning.map(p =>
                        `<strong>${p.part_type}</strong> (${p.days_since_update} days old)`
                    ).join(', ');
                    stalePriceWarningHtml = `
                        <div class="stale-price-warning" style="margin-bottom:20px;padding:16px;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;">
                            <div style="display:flex;align-items:flex-start;gap:12px;">
                                <span style="font-size:1.5rem;">⚠️</span>
                                <div>
                                    <p style="margin:0 0 8px;color:#92400e;font-weight:600;">
                                        Price Data Needs Refreshing
                                    </p>
                                    <p style="margin:0 0 12px;color:#92400e;font-size:0.9rem;">
                                        The following parts have saved prices older than 3 days: ${stalePartsList}
                                    </p>
                                    <p style="margin:0;color:#92400e;font-size:0.85rem;">
                                        Please search eBay for current sold listings and re-enter prices to ensure accuracy.
                                    </p>
                                    <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;">
                                        ${data.stale_parts_warning.map(p => {
                                            const searchQuery = `${selection.generation}${selection.connector_type ? ' ' + selection.connector_type : ''} ${p.part_type === 'case' ? 'charging case' : p.part_type + ' earbud'}`;
                                            const ebayUrl = `https://www.ebay.co.uk/sch/i.html?_nkw=${encodeURIComponent(searchQuery)}&LH_Complete=1&LH_Sold=1`;
                                            return `
                                                <button class="btn btn-sm" onclick="openManualEntryModal('${p.part_type}', '${searchQuery}', '${searchQuery}', '${ebayUrl}')"
                                                    style="padding:6px 12px;font-size:0.8rem;background:#f59e0b;color:white;border:none;border-radius:4px;cursor:pointer;">
                                                    Refresh ${p.part_type} prices
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Build the result HTML with support for partial parts
                const getPartRow = (partType, label) => {
                    if (!selectedParts.includes(partType)) {
                        return ''; // Don't show parts that weren't selected
                    }
                    const part = calc.parts[partType];
                    const isManual = manualPriceData[partType]?.is_manual || part?.is_manual;
                    const isSaved = part?.is_saved;
                    const isStale = part?.is_stale;
                    const daysSinceUpdate = part?.days_since_update;

                    if (part) {
                        let badge = '';
                        if (isManual && !isSaved) {
                            badge = ' <span class="manual-data-badge">Manual</span>';
                        } else if (isStale) {
                            badge = ` <span class="stale-data-badge" style="background:#f59e0b;color:white;font-size:0.7rem;padding:2px 6px;border-radius:3px;margin-left:4px;">Stale (${daysSinceUpdate}d)</span>`;
                        } else if (isSaved) {
                            badge = ` <span class="saved-data-badge" style="background:#10b981;color:white;font-size:0.7rem;padding:2px 6px;border-radius:3px;margin-left:4px;">Saved</span>`;
                        }
                        return `
                            <div class="calc-row indent">
                                <span>${label}${badge}</span>
                                <span>£${part.avg_sale_price.toFixed(2)}</span>
                            </div>
                        `;
                    }
                    return `<div class="calc-row indent"><span>${label}</span><span class="no-data-part">No data</span></div>`;
                };

                resultDiv.innerHTML = `
                    <div class="calculator-result">
                        ${stalePriceWarningHtml}
                        <div class="calculator-card">
                            <h3>${data.display_name} - ${partsDisplayName}</h3>

                            <div class="calc-section-title">Expected Sale Revenue</div>
                            ${getPartRow('left', 'Left Earbud')}
                            ${getPartRow('right', 'Right Earbud')}
                            ${getPartRow('case', 'Charging Case')}
                            <div class="calc-row subtotal">
                                <span>Combined Sale Value</span>
                                <span>£${calc.combined_sale_price.toFixed(2)}</span>
                            </div>

                            <div class="calc-section-title">Deductions</div>
                            <div class="calc-row">
                                <span>Platform Fees (avg)${data.fee_estimation && data.fee_estimation.has_estimated_fees ? ` <span class="fee-estimate-badge" title="Fees estimated at ${data.fee_estimation.fee_percentage}% based on ${data.fee_estimation.sample_size > 0 ? data.fee_estimation.sample_size + ' recent sales' : 'default rate'}">(est.)</span>` : ''}</span>
                                <span class="minus">-£${calc.combined_fees.toFixed(2)}</span>
                            </div>
                            <div class="calc-row">
                                <span>Consumables (avg)</span>
                                <span class="minus">-£${calc.combined_consumables.toFixed(2)}</span>
                            </div>
                            ${calc.postage_charged > 0 ? `
                            <div class="calc-row">
                                <span>Postage Charged</span>
                                <span class="minus">-£${calc.postage_charged.toFixed(2)}</span>
                            </div>
                            ` : ''}
                            <div class="calc-row subtotal">
                                <span>Net Revenue</span>
                                <span>£${calc.net_revenue.toFixed(2)}</span>
                            </div>

                            <div class="calc-section-title">Profit Target</div>
                            <div class="calc-row">
                                <span>Minimum Profit</span>
                                <span class="minus">-£${minProfit.toFixed(2)}</span>
                            </div>

                            <div class="calc-row total">
                                <span>Max Bid Price</span>
                                <span>£${calc.max_bid.toFixed(2)}</span>
                            </div>
                        </div>

                        ${data.historical_price ? `
                            <div class="historical-comparison" style="max-width:500px;margin-top:20px;">
                                <h4>Historical Purchase Price Comparison</h4>
                                <div class="comparison-row">
                                    <span>Avg purchase price (from your data)</span>
                                    <span>£${data.historical_price.toFixed(2)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span>Calculated max bid</span>
                                    <span>£${calc.max_bid.toFixed(2)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span>Difference</span>
                                    <span style="color:${calc.max_bid >= data.historical_price ? '#10b981' : '#ef4444'}">
                                        ${calc.max_bid >= data.historical_price ? '+' : ''}£${(calc.max_bid - data.historical_price).toFixed(2)}
                                        (${((calc.max_bid - data.historical_price) / data.historical_price * 100).toFixed(1)}%)
                                    </span>
                                </div>
                                <div class="verdict ${calc.max_bid >= data.historical_price ? 'good' : calc.max_bid >= data.historical_price * 0.9 ? 'warning' : 'bad'}">
                                    ${calc.max_bid >= data.historical_price
                                        ? 'Max bid is achievable based on historical purchases'
                                        : calc.max_bid >= data.historical_price * 0.9
                                            ? 'Max bid is slightly below historical avg - may be difficult to achieve'
                                            : 'Max bid is significantly below historical avg - unlikely to find at this price'}
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-top:20px;padding:16px;background:#f0fdf4;border-radius:8px;max-width:500px;">
                            <p style="margin:0;font-size:0.85rem;color:#166534;">
                                <strong>Summary:</strong> To make £${minProfit.toFixed(2)} profit on ${data.display_name} (${partsDisplayName}),
                                you should bid no more than <strong>£${calc.max_bid.toFixed(2)}</strong>.
                            </p>
                        </div>
                    </div>
                `;

            } catch (err) {
                resultDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            }
        }

        // Load recent sales data from system and apply to manual price data
        async function loadRecentSales() {
            if (!currentSelection) {
                alert('Please select a generation first.');
                return;
            }

            const btn = document.getElementById('loadRecentSalesBtn');
            const statusDiv = document.getElementById('recentSalesStatus');

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="animation: spin 1s linear infinite;">
                        <path d="M2 8C2 4.68629 4.68629 2 8 2C10.0503 2 11.8574 3.00442 12.9554 4.54404M14 8C14 11.3137 11.3137 14 8 14C5.94972 14 4.14265 12.9956 3.04464 11.456" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    Loading...
                `;
            }

            if (statusDiv) {
                statusDiv.style.display = 'none';
            }

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                const params = new URLSearchParams({
                    generation: currentSelection.generation,
                    connector_type: currentSelection.connector_type || '',
                    limit: 5
                });

                const response = await authenticatedFetch(`/api/admin/price-snapshot/recent-sales?${params}`);
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to load recent sales');
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load recent sales');
                }

                // Check if we have any sales data
                if (data.parts_with_data === 0) {
                    if (statusDiv) {
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = `
                            <div style="padding:12px;background:#fef3c7;border-radius:6px;color:#92400e;">
                                <strong>No sales data found</strong> for ${data.display_name}.
                                <br><small>You'll need to enter prices manually from eBay.</small>
                            </div>
                        `;
                    }
                    return;
                }

                // Apply the recent sales data to manualPriceData
                let appliedParts = [];
                let appliedDetails = [];
                const selectedParts = getSelectedParts();

                for (const partType of ['left', 'right', 'case']) {
                    if (!selectedParts.includes(partType)) continue;

                    const partData = data.recent_sales[partType];
                    if (partData && partData.prices && partData.prices.length > 0) {
                        manualPriceData[partType] = {
                            avg_sale_price: partData.avg_price,
                            prices: partData.prices,
                            is_manual: true,
                            is_from_recent_sales: true,
                            sales_count: partData.sales_count
                        };
                        appliedParts.push(partType);

                        // Format dates for display
                        const newestDate = partData.newest_sale_date ? new Date(partData.newest_sale_date).toLocaleDateString() : 'N/A';
                        const oldestDate = partData.oldest_sale_date ? new Date(partData.oldest_sale_date).toLocaleDateString() : 'N/A';
                        appliedDetails.push({
                            partType,
                            avgPrice: partData.avg_price,
                            salesCount: partData.sales_count,
                            dateRange: partData.sales_count > 1 ? `${oldestDate} - ${newestDate}` : newestDate
                        });

                        // Save to database for persistence
                        try {
                            await authenticatedFetch('/api/admin/price-snapshot/manual-prices', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    generation: currentSelection.generation,
                                    connector_type: currentSelection.connector_type || null,
                                    part_type: partType,
                                    prices: partData.prices
                                })
                            });
                        } catch (saveErr) {
                            console.error('Failed to save recent sales prices:', saveErr);
                        }
                    }
                }

                if (appliedParts.length > 0) {
                    if (statusDiv) {
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = `
                            <div style="padding:12px;background:#d1fae5;border-radius:6px;color:#047857;">
                                <strong>Loaded ${appliedParts.length} part(s) from recent sales:</strong>
                                <ul style="margin:8px 0 0 20px;padding:0;">
                                    ${appliedDetails.map(d => `
                                        <li style="margin-bottom:4px;">
                                            <span class="part-type-badge ${d.partType}" style="font-size:0.7rem;padding:2px 6px;">${d.partType}</span>
                                            £${d.avgPrice.toFixed(2)} avg (${d.salesCount} sales, ${d.dateRange})
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    // Re-calculate bid with the new data
                    setTimeout(() => calculateBid(), 100);
                } else {
                    if (statusDiv) {
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = `
                            <div style="padding:12px;background:#fef3c7;border-radius:6px;color:#92400e;">
                                <strong>No matching sales found</strong> for the selected parts.
                                <br><small>You'll need to enter prices manually from eBay.</small>
                            </div>
                        `;
                    }
                }

            } catch (err) {
                console.error('Error loading recent sales:', err);
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `
                        <div style="padding:12px;background:#fee2e2;border-radius:6px;color:#b91c1c;">
                            <strong>Error:</strong> ${err.message}
                        </div>
                    `;
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 8C2 4.68629 4.68629 2 8 2C10.0503 2 11.8574 3.00442 12.9554 4.54404M14 8C14 11.3137 11.3137 14 8 14C5.94972 14 4.14265 12.9956 3.04464 11.456" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M12.9554 4.54404L13.5 2.5M12.9554 4.54404L10.9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Load Recent Sales
                    `;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadBidCalcOptions, 200);
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeManualEntryModal();
            }
        });
    </script>
</body>
</html>
