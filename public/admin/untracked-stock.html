<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Untracked Stock | LJM Admin</title>
    <link rel="stylesheet" href="../css/styles.css?v=1.2.7">
    <link rel="stylesheet" href="../css/ios-mobile-optimizations.css">
    <style>
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .page-header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: #333;
        }
        .header-actions {
            display: flex;
            gap: 15px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: var(--accent-teal);
            color: white;
        }
        .btn-primary:hover {
            background: #138496;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
        }
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-teal);
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .card h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--accent-teal);
            outline: none;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        .items-table {
            width: 100%;
            border-collapse: collapse;
        }
        .items-table th,
        .items-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .items-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .items-table tr:hover {
            background: #f8f9fa;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        .badge-matched {
            background: #d4edda;
            color: #155724;
        }
        .badge-converted {
            background: #cce5ff;
            color: #004085;
        }
        .badge-written-off {
            background: #f8d7da;
            color: #721c24;
        }
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
        }
        .action-btn-edit {
            background: #e9ecef;
            color: #333;
        }
        .action-btn-delete {
            background: #dc3545;
            color: white;
        }
        .action-btn-checkin {
            background: var(--accent-teal);
            color: white;
        }
        .action-btn-checkin:hover {
            background: #138496;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .success-banner, .error-banner {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .success-banner {
            background: #d4edda;
            color: #155724;
        }
        .error-banner {
            background: #f8d7da;
            color: #721c24;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-row select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .header-actions {
                width: 100%;
            }
            .header-actions .btn {
                flex: 1;
                justify-content: center;
            }
        }
        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 99999;
        }
        .modal-overlay.active {
            display: block !important;
        }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100000;
        }
        .modal h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }
        .modal-item-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .modal-item-details p {
            margin: 8px 0;
        }
        .modal-item-details strong {
            color: #666;
            display: inline-block;
            width: 120px;
        }
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
    </style>
</head>
<body class="admin-panel">
    <!-- Sidebar Navigation -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-circle">
                    <span class="logo-text">LJM</span>
                </div>
                <div>
                    <div class="sidebar-logo-text">LJM Admin</div>
                    <div class="sidebar-subtitle">Dashboard</div>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link" data-page="dashboard">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 10L9 4L9 10L17 10M3 10L3 16M3 10L17 10M17 10L17 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                    </li>

                    <li class="nav-item has-submenu">
                        <a href="#" class="nav-link" data-page="inventory" onclick="event.preventDefault(); toggleSubmenu(this.parentElement);">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 5L10 2L17 5M3 5L3 15L10 18M3 5L10 8M17 5L17 15L10 18M17 5L10 8M10 8L10 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Inventory</span>
                        </a>
                        <ul class="nav-submenu">
                            <li class="nav-item">
                                <a href="products.html" class="nav-link" data-page="products">
                                    <span>Products</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="parts.html" class="nav-link" data-page="parts">
                                    <span>Manage Parts</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="purchases.html" class="nav-link" data-page="purchases">
                                    <span>Purchases</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="check-in.html" class="nav-link" data-page="check-in">
                                    <span>Check-In</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="consumables.html" class="nav-link" data-page="consumables">
                                    <span>Consumables</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="untracked-stock.html" class="nav-link active" data-page="untracked-stock">
                                    <span>Untracked Stock</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="reconciliation.html" class="nav-link" data-page="reconciliation">
                                    <span>Reconciliation</span>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-item has-submenu">
                        <a href="#" class="nav-link" data-page="sales-category" onclick="event.preventDefault(); toggleSubmenu(this.parentElement);">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L5 9L2 12L5 15L8 12L15 5M14 7L17 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="14.5" cy="5.5" r="1.5" fill="currentColor"/>
                            </svg>
                            <span>Sales</span>
                        </a>
                        <ul class="nav-submenu">
                            <li class="nav-item">
                                <a href="sales.html" class="nav-link" data-page="sales">
                                    <span>Sales Orders</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="addon-sales.html" class="nav-link" data-page="addon-sales">
                                    <span>Add-On Sales</span>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-item">
                        <a href="tasks.html" class="nav-link" data-page="tasks">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 5H7C5.89543 5 5 5.89543 5 7V15C5 16.1046 5.89543 17 7 17H13C14.1046 17 15 16.1046 15 15V7C15 5.89543 14.1046 5 13 5H11M9 5C9 3.89543 9.89543 3 11 3H9C7.89543 3 7 3.89543 7 5M9 5C9 6.10457 9.89543 7 11 7H9C7.89543 7 7 6.10457 7 5M8 10H12M8 13H12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Tasks</span>
                        </a>
                    </li>

                    <li class="nav-item has-submenu">
                        <a href="#" class="nav-link" data-page="tools-category" onclick="event.preventDefault(); toggleSubmenu(this.parentElement);">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14.7 6.3a1 1 0 0 0 0-1.4l-1.6-1.6a1 1 0 0 0-1.4 0l-1.4 1.4-2.2-2.2a1 1 0 0 0-1.4 0L3.3 5.9a1 1 0 0 0 0 1.4l2.2 2.2-4.8 4.8a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l4.8-4.8 2.2 2.2a1 1 0 0 0 1.4 0l3.4-3.4a1 1 0 0 0 0-1.4l-2.2-2.2 1.4-1.4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Tools</span>
                        </a>
                        <ul class="nav-submenu">
                            <li class="nav-item">
                                <a href="ebay-import.html" class="nav-link" data-page="ebay-import">
                                    <span>eBay Import</span>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-item">
                        <a href="settings.html" class="nav-link" data-page="settings">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 13C11.6569 13 13 11.6569 13 10C13 8.34315 11.6569 7 10 7C8.34315 7 7 8.34315 7 10C7 11.6569 8.34315 13 10 13Z" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M17.4 10C17.4 10 17.4 10 17.4 10C17.4 9.5 17.2 9 16.8 8.6L15.8 7.6C15.5 7.3 15.3 6.9 15.3 6.5C15.3 6.1 15.4 5.7 15.6 5.4L16.1 4.7C16.3 4.4 16.3 4 16.1 3.7L15.3 2.5C15.1 2.2 14.7 2.1 14.3 2.2L13.5 2.5C13.1 2.7 12.7 2.7 12.3 2.6C11.9 2.5 11.6 2.2 11.4 1.9L11.1 1.1C11 0.7 10.6 0.5 10.2 0.5H8.8C8.4 0.5 8 0.7 7.9 1.1L7.6 1.9C7.4 2.2 7.1 2.5 6.7 2.6C6.3 2.7 5.9 2.7 5.5 2.5L4.7 2.2C4.3 2.1 3.9 2.2 3.7 2.5L2.9 3.7C2.7 4 2.7 4.4 2.9 4.7L3.4 5.4C3.6 5.7 3.7 6.1 3.7 6.5C3.7 6.9 3.5 7.3 3.2 7.6L2.2 8.6C1.8 9 1.6 9.5 1.6 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <div class="page-container">
            <div class="success-banner" id="successBanner"></div>
            <div class="error-banner" id="errorBanner"></div>

            <div class="page-header">
                <h1>Untracked Stock</h1>
                <div class="header-actions">
                    <a href="reconciliation.html" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Reconciliation
                    </a>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <h3>Pending Items</h3>
                    <div class="value" id="pendingCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Matched</h3>
                    <div class="value" id="matchedCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Written Off</h3>
                    <div class="value" id="writtenOffCount">0</div>
                </div>
            </div>

            <!-- Add New Item Form -->
            <div class="card">
                <h2>Add Untracked Stock Item</h2>
                <form id="addItemForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="generation">Generation *</label>
                            <select id="generation" name="generation" required>
                                <option value="">Select Generation</option>
                                <option value="AirPods 1st Gen">AirPods 1st Gen</option>
                                <option value="AirPods 2nd Gen">AirPods 2nd Gen</option>
                                <option value="AirPods 3rd Gen">AirPods 3rd Gen</option>
                                <option value="AirPods 4th Gen">AirPods 4th Gen</option>
                                <option value="AirPods 4th Gen ANC">AirPods 4th Gen ANC</option>
                                <option value="AirPods Pro 1st Gen">AirPods Pro 1st Gen</option>
                                <option value="AirPods Pro 2nd Gen">AirPods Pro 2nd Gen</option>
                                <option value="AirPods Max">AirPods Max</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="part_type">Part Type *</label>
                            <select id="part_type" name="part_type" required>
                                <option value="">Select Part Type</option>
                                <option value="left">Left Earbud</option>
                                <option value="right">Right Earbud</option>
                                <option value="case">Charging Case</option>
                                <option value="full_set">Full Set</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="connector_type">Connector Type</label>
                            <select id="connector_type" name="connector_type">
                                <option value="">Not Applicable</option>
                                <option value="Lightning">Lightning</option>
                                <option value="USB-C">USB-C</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serial_number">Serial Number</label>
                            <input type="text" id="serial_number" name="serial_number" placeholder="Enter serial number if available">
                        </div>
                        <div class="form-group">
                            <label for="security_barcode">Security Barcode</label>
                            <input type="text" id="security_barcode" name="security_barcode" placeholder="Enter security barcode (or leave blank to auto-generate)">
                        </div>
                        <div class="form-group">
                            <label for="condition">Condition</label>
                            <select id="condition" name="condition">
                                <option value="unknown">Unknown</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="acceptable">Acceptable</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Genuine?</label>
                            <select id="is_genuine" name="is_genuine">
                                <option value="">Unknown</option>
                                <option value="true">Yes - Genuine</option>
                                <option value="false">No - Fake/Replica</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" rows="3" placeholder="Add any notes about this item..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add Item</button>
                        <button type="reset" class="btn btn-secondary">Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Items List -->
            <div class="card">
                <h2>Untracked Items</h2>
                <div class="filter-row">
                    <select id="filterStatus">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="matched">Matched</option>
                        <option value="converted_to_product">Converted</option>
                        <option value="written_off">Written Off</option>
                    </select>
                    <select id="filterGeneration">
                        <option value="">All Generations</option>
                        <option value="AirPods 1st Gen">AirPods 1st Gen</option>
                        <option value="AirPods 2nd Gen">AirPods 2nd Gen</option>
                        <option value="AirPods 3rd Gen">AirPods 3rd Gen</option>
                        <option value="AirPods 4th Gen">AirPods 4th Gen</option>
                        <option value="AirPods 4th Gen ANC">AirPods 4th Gen ANC</option>
                        <option value="AirPods Pro 1st Gen">AirPods Pro 1st Gen</option>
                        <option value="AirPods Pro 2nd Gen">AirPods Pro 2nd Gen</option>
                        <option value="AirPods Max">AirPods Max</option>
                    </select>
                </div>
                <div id="itemsContainer">
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <p>No untracked stock items found</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Check-In Modal -->
    <div class="modal-overlay" id="checkInModal">
        <div class="modal">
            <h2>Check In Untracked Item</h2>
            <p style="color: #666; margin-bottom: 20px;">Review the item details and set a purchase price to add it to your inventory.</p>

            <div class="modal-item-details" id="modalItemDetails">
                <!-- Populated by JavaScript -->
            </div>

            <div class="form-group">
                <label for="modal_purchase_price">Purchase Price (Â£) *</label>
                <input type="number" id="modal_purchase_price" step="0.01" min="0" placeholder="Enter purchase price" required>
            </div>

            <div class="form-group">
                <label for="modal_notes">Additional Notes</label>
                <textarea id="modal_notes" rows="2" placeholder="Any notes about this check-in..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCheckInModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmCheckInBtn">Add to Inventory</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.API_BASE || '';
        let allItems = [];

        // Get auth token
        function getAuthToken() {
            return localStorage.getItem('accessToken');
        }

        // Get auth headers
        function getAuthHeaders() {
            const token = getAuthToken();
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // Toggle submenu
        function toggleSubmenu(element) {
            element.classList.toggle('open');
        }

        // Show success message
        function showSuccess(message) {
            const banner = document.getElementById('successBanner');
            banner.textContent = message;
            banner.style.display = 'block';
            setTimeout(() => banner.style.display = 'none', 5000);
        }

        // Show error message
        function showError(message) {
            const banner = document.getElementById('errorBanner');
            banner.textContent = message;
            banner.style.display = 'block';
            setTimeout(() => banner.style.display = 'none', 5000);
        }

        // Load items
        async function loadItems() {
            try {
                const token = getAuthToken();
                const response = await fetch(API_BASE + '/api/admin/untracked-stock', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    allItems = data.items;
                    updateStats();
                    renderItems();
                } else {
                    showError('Failed to load items');
                }
            } catch (err) {
                console.error('Error loading items:', err);
                showError('Failed to load items: ' + err.message);
            }
        }

        // Update stats
        function updateStats() {
            const pending = allItems.filter(i => i.status === 'pending').length;
            const matched = allItems.filter(i => i.status === 'matched' || i.status === 'converted_to_product').length;
            const writtenOff = allItems.filter(i => i.status === 'written_off').length;

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('matchedCount').textContent = matched;
            document.getElementById('writtenOffCount').textContent = writtenOff;
        }

        // Render items table
        function renderItems() {
            const container = document.getElementById('itemsContainer');
            const statusFilter = document.getElementById('filterStatus').value;
            const genFilter = document.getElementById('filterGeneration').value;

            let filteredItems = allItems;
            if (statusFilter) {
                filteredItems = filteredItems.filter(i => i.status === statusFilter);
            }
            if (genFilter) {
                filteredItems = filteredItems.filter(i => i.generation === genFilter);
            }

            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <p>No untracked stock items found</p>
                    </div>
                `;
                return;
            }

            const statusBadge = (status) => {
                const classes = {
                    'pending': 'badge-pending',
                    'matched': 'badge-matched',
                    'converted_to_product': 'badge-converted',
                    'written_off': 'badge-written-off'
                };
                const labels = {
                    'pending': 'Pending',
                    'matched': 'Matched',
                    'converted_to_product': 'Converted',
                    'written_off': 'Written Off'
                };
                return `<span class="badge ${classes[status] || 'badge-pending'}">${labels[status] || status}</span>`;
            };

            const partTypeLabel = (type) => {
                const labels = {
                    'left': 'Left Earbud',
                    'right': 'Right Earbud',
                    'case': 'Charging Case',
                    'full_set': 'Full Set'
                };
                return labels[type] || type;
            };

            container.innerHTML = `
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Generation</th>
                            <th>Part Type</th>
                            <th>Serial Number</th>
                            <th>Condition</th>
                            <th>Status</th>
                            <th>Date Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredItems.map(item => `
                            <tr>
                                <td>${item.generation}</td>
                                <td>${partTypeLabel(item.part_type)}</td>
                                <td>${item.serial_number || '-'}</td>
                                <td>${item.condition || 'Unknown'}</td>
                                <td>${statusBadge(item.status)}</td>
                                <td>${new Date(item.created_at).toLocaleDateString()}</td>
                                <td>
                                    ${item.status === 'pending' ? `
                                        <button class="action-btn action-btn-checkin" onclick="openCheckInModal('${item._id}')">Check In</button>
                                        <button class="action-btn action-btn-delete" onclick="deleteItem('${item._id}')">Delete</button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Add item
        document.getElementById('addItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                generation: document.getElementById('generation').value,
                part_type: document.getElementById('part_type').value,
                connector_type: document.getElementById('connector_type').value || null,
                serial_number: document.getElementById('serial_number').value || null,
                security_barcode: document.getElementById('security_barcode').value || null,
                condition: document.getElementById('condition').value,
                is_genuine: document.getElementById('is_genuine').value === '' ? null : document.getElementById('is_genuine').value === 'true',
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch(API_BASE + '/api/admin/untracked-stock', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Item added successfully');
                    document.getElementById('addItemForm').reset();
                    loadItems();
                } else {
                    showError(data.error || 'Failed to add item');
                }
            } catch (err) {
                console.error('Error adding item:', err);
                showError('Failed to add item: ' + err.message);
            }
        });

        // Check-in modal functions
        let currentCheckInItem = null;

        function openCheckInModal(itemId) {
            const item = allItems.find(i => i._id === itemId);
            if (!item) {
                showError('Item not found');
                return;
            }

            currentCheckInItem = item;

            const partTypeLabels = {
                'left': 'Left Earbud',
                'right': 'Right Earbud',
                'case': 'Charging Case',
                'full_set': 'Full Set'
            };

            document.getElementById('modalItemDetails').innerHTML = `
                <p><strong>Generation:</strong> ${item.generation}</p>
                <p><strong>Part Type:</strong> ${partTypeLabels[item.part_type] || item.part_type}</p>
                <p><strong>Connector:</strong> ${item.connector_type || 'N/A'}</p>
                <p><strong>Serial Number:</strong> ${item.serial_number || 'N/A'}</p>
                <p><strong>Security Barcode:</strong> ${item.security_barcode || 'Will be auto-generated'}</p>
                <p><strong>Condition:</strong> ${item.condition || 'Unknown'}</p>
                <p><strong>Genuine:</strong> ${item.is_genuine === true ? 'Yes' : item.is_genuine === false ? 'No' : 'Unknown'}</p>
                ${item.notes ? `<p><strong>Notes:</strong> ${item.notes}</p>` : ''}
            `;

            document.getElementById('modal_purchase_price').value = '';
            document.getElementById('modal_notes').value = '';
            document.getElementById('checkInModal').classList.add('active');
        }

        function closeCheckInModal() {
            document.getElementById('checkInModal').classList.remove('active');
            currentCheckInItem = null;
        }

        // Handle confirm check-in
        document.getElementById('confirmCheckInBtn').addEventListener('click', async () => {
            if (!currentCheckInItem) return;

            const purchasePrice = document.getElementById('modal_purchase_price').value;
            if (!purchasePrice || parseFloat(purchasePrice) < 0) {
                showError('Please enter a valid purchase price');
                return;
            }

            const notes = document.getElementById('modal_notes').value;

            try {
                // First create a reconciliation session if needed, then convert to product
                const token = getAuthToken();

                // Create a simple reconciliation to convert directly to product
                const reconciliationResponse = await fetch(API_BASE + '/api/admin/reconciliation', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        name: `Quick Check-In - ${new Date().toLocaleString()}`
                    })
                });

                const reconciliationData = await reconciliationResponse.json();
                if (!reconciliationData.success) {
                    throw new Error(reconciliationData.error || 'Failed to create reconciliation session');
                }

                const reconciliationId = reconciliationData.reconciliation._id;

                // Convert to product
                const convertResponse = await fetch(API_BASE + `/api/admin/reconciliation/${reconciliationId}/convert-to-product`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        untracked_stock_id: currentCheckInItem._id,
                        purchase_price: parseFloat(purchasePrice),
                        notes: notes
                    })
                });

                const convertData = await convertResponse.json();

                if (convertData.success) {
                    showSuccess('Item checked in and added to inventory successfully!');
                    closeCheckInModal();
                    loadItems();
                } else {
                    throw new Error(convertData.error || 'Failed to check in item');
                }
            } catch (err) {
                console.error('Error checking in item:', err);
                showError('Failed to check in item: ' + err.message);
            }
        });

        // Close modal on overlay click
        document.getElementById('checkInModal').addEventListener('click', (e) => {
            if (e.target.id === 'checkInModal') {
                closeCheckInModal();
            }
        });

        // Delete item
        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            try {
                const token = getAuthToken();
                const response = await fetch(API_BASE + '/api/admin/untracked-stock/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Item deleted');
                    loadItems();
                } else {
                    showError(data.error || 'Failed to delete item');
                }
            } catch (err) {
                console.error('Error deleting item:', err);
                showError('Failed to delete item: ' + err.message);
            }
        }

        // Filter change handlers
        document.getElementById('filterStatus').addEventListener('change', renderItems);
        document.getElementById('filterGeneration').addEventListener('change', renderItems);

        // Auto-open inventory submenu
        document.addEventListener('DOMContentLoaded', () => {
            const inventoryMenu = document.querySelector('[data-page="inventory"]');
            if (inventoryMenu) {
                inventoryMenu.parentElement.classList.add('open');
            }
            loadItems();
        });
    </script>
</body>
</html>
