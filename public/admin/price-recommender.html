<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Price Snapshot | LJM Admin</title>
    <link rel="stylesheet" href="../css/styles.css?v=1.2.7">
    <link rel="stylesheet" href="../css/ios-mobile-optimizations.css">
    <style>
        .snapshot-controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .snapshot-controls label {
            font-size: 0.9rem;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .snapshot-controls input {
            width: 70px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .snapshot-controls input.budget-input {
            width: 100px;
        }
        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .snapshot-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .snapshot-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .generation-name {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
        }
        .sales-count {
            font-size: 0.75rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .max-bid {
            font-size: 2rem;
            font-weight: 700;
            color: #0d9488;
            margin: 8px 0;
        }
        .max-bid-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 16px;
        }
        .breakdown {
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
            font-size: 0.85rem;
        }
        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            color: #4b5563;
        }
        .breakdown-row.highlight {
            font-weight: 600;
            color: #1f2937;
            border-top: 1px solid #e5e7eb;
            margin-top: 6px;
            padding-top: 6px;
        }
        .breakdown-row .minus { color: #ef4444; }
        .breakdown-row .plus { color: #10b981; }
        .last-sale {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 10px;
        }
        .loading, .error, .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .error { color: #ef4444; }
        .timestamp {
            text-align: center;
            color: #9ca3af;
            font-size: 0.8rem;
            margin-top: 20px;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: #f3f4f6;
            padding: 4px;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background: rgba(255,255,255,0.5);
            color: #374151;
        }
        .tab-btn.active {
            background: white;
            color: #0d9488;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Full Set Cards */
        .parts-breakdown {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #e5e7eb;
        }
        .part-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 0.8rem;
            color: #6b7280;
        }
        .part-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }
        .part-type-badge.left { background: #dbeafe; color: #1d4ed8; }
        .part-type-badge.right { background: #fce7f3; color: #be185d; }
        .part-type-badge.case { background: #d1fae5; color: #047857; }
        .part-missing {
            color: #9ca3af;
            font-style: italic;
        }

        /* Best Sellers Table */
        .sellers-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .sellers-table th,
        .sellers-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .sellers-table th {
            background: #f9fafb;
            font-weight: 600;
            font-size: 0.8rem;
            color: #374151;
            text-transform: uppercase;
        }
        .sellers-table td {
            font-size: 0.9rem;
            color: #4b5563;
        }
        .sellers-table tr:last-child td {
            border-bottom: none;
        }
        .velocity-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .velocity-badge.fast { background: #d1fae5; color: #047857; }
        .velocity-badge.moderate { background: #fef3c7; color: #92400e; }
        .velocity-badge.slow { background: #fee2e2; color: #b91c1c; }
        .velocity-badge.no_sales { background: #f3f4f6; color: #6b7280; }

        /* Investment Optimizer */
        .investment-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-card .label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        .summary-card .value.profit {
            color: #10b981;
        }
        .summary-card .value.investment {
            color: #0d9488;
        }
        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .recommendation-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }
        .recommendation-card .rec-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px 0;
        }
        .recommendation-card .rec-details {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: #6b7280;
        }
        .recommendation-card .rec-details span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .recommendation-card .rec-action {
            text-align: right;
        }
        .recommendation-card .quantity {
            font-size: 2rem;
            font-weight: 700;
            color: #0d9488;
        }
        .recommendation-card .quantity-label {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .priority-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .priority-badge.high { background: #d1fae5; color: #047857; }
        .priority-badge.medium { background: #fef3c7; color: #92400e; }
        .priority-badge.low { background: #f3f4f6; color: #6b7280; }

        /* Price flag badges */
        .price-flag-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .price-flag-badge.realistic { background: #d1fae5; color: #047857; }
        .price-flag-badge.below_historical { background: #fef3c7; color: #92400e; }
        .price-flag-badge.unrealistic { background: #fee2e2; color: #b91c1c; }

        .historical-price-note {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
        }
        .historical-price-note.warning {
            color: #92400e;
        }

        /* Flagged section */
        .flagged-section {
            margin-top: 32px;
            padding: 20px;
            background: #fef2f2;
            border-radius: 12px;
            border: 1px solid #fecaca;
        }
        .flagged-section h4 {
            color: #b91c1c;
            margin: 0 0 16px 0;
            font-size: 1rem;
        }
        .flagged-item {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .flagged-item:last-child {
            margin-bottom: 0;
        }
        .flagged-item .name {
            font-weight: 600;
            color: #1f2937;
        }
        .flagged-item .reason {
            font-size: 0.8rem;
            color: #b91c1c;
        }
        .flagged-item .prices {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Bid Calculator */
        .bid-calculator-form {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .bid-calculator-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .bid-calculator-form label {
            font-size: 0.85rem;
            color: #374151;
            font-weight: 500;
        }
        .bid-calculator-form select {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: 250px;
            background: white;
        }
        .calculator-result {
            margin-top: 24px;
        }
        .calculator-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-width: 500px;
        }
        .calculator-card h3 {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
            color: #1f2937;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .calc-row.indent {
            padding-left: 20px;
            font-size: 0.85rem;
            color: #6b7280;
        }
        .calc-row.subtotal {
            border-top: 1px solid #e5e7eb;
            margin-top: 8px;
            padding-top: 12px;
            font-weight: 600;
            color: #1f2937;
        }
        .calc-row.total {
            border-top: 2px solid #0d9488;
            margin-top: 12px;
            padding-top: 16px;
            font-weight: 700;
            font-size: 1.1rem;
            color: #0d9488;
        }
        .calc-row .minus { color: #ef4444; }
        .calc-row .plus { color: #10b981; }
        .calc-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #9ca3af;
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .no-data-part {
            color: #9ca3af;
            font-style: italic;
        }
        .historical-comparison {
            margin-top: 20px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .historical-comparison h4 {
            margin: 0 0 12px 0;
            font-size: 0.9rem;
            color: #374151;
        }
        .historical-comparison .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85rem;
        }
        .historical-comparison .verdict {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }
        .historical-comparison .verdict.good { background: #d1fae5; color: #047857; }
        .historical-comparison .verdict.warning { background: #fef3c7; color: #92400e; }
        .historical-comparison .verdict.bad { background: #fee2e2; color: #b91c1c; }

        /* Responsive */
        @media (max-width: 768px) {
            .tab-btn {
                min-width: 80px;
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            .sellers-table {
                display: block;
                overflow-x: auto;
            }
            .recommendation-card {
                grid-template-columns: 1fr;
            }
            .recommendation-card .rec-action {
                text-align: left;
                display: flex;
                gap: 16px;
                align-items: center;
            }
        }
    </style>
</head>
<body class="admin-panel">
    <!-- Sidebar Navigation -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-circle">
                    <span class="logo-text">LJM</span>
                </div>
                <div>
                    <div class="sidebar-logo-text">LJM Admin</div>
                    <div class="sidebar-subtitle">Dashboard</div>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link" data-page="dashboard">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 10L9 4L9 10L17 10M3 10L3 16M3 10L17 10M17 10L17 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item has-submenu">
                        <a href="#" class="nav-link" data-page="inventory" onclick="event.preventDefault(); toggleSubmenu(this.parentElement);">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 5L10 2L17 5M3 5L3 15L10 18M3 5L10 8M17 5L17 15L10 18M17 5L10 8M10 8L10 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Inventory</span>
                        </a>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="products.html" class="nav-link"><span>Products</span></a></li>
                            <li class="nav-item"><a href="parts.html" class="nav-link"><span>Manage Parts</span></a></li>
                            <li class="nav-item"><a href="purchases.html" class="nav-link"><span>Purchases</span></a></li>
                            <li class="nav-item"><a href="check-in.html" class="nav-link"><span>Check-In</span></a></li>
                            <li class="nav-item"><a href="consumables.html" class="nav-link"><span>Consumables</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item has-submenu">
                        <a href="#" class="nav-link" data-page="sales-category" onclick="event.preventDefault(); toggleSubmenu(this.parentElement);">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L5 9L2 12L5 15L8 12L15 5M14 7L17 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="14.5" cy="5.5" r="1.5" fill="currentColor"/>
                            </svg>
                            <span>Sales</span>
                        </a>
                        <ul class="nav-submenu">
                            <li class="nav-item"><a href="sales.html" class="nav-link"><span>Sales Orders</span></a></li>
                            <li class="nav-item"><a href="addon-sales.html" class="nav-link"><span>Add-On Sales</span></a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="tasks.html" class="nav-link" data-page="tasks">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 5H7C5.89543 5 5 5.89543 5 7V15C5 16.1046 5.89543 17 7 17H13C14.1046 17 15 16.1046 15 15V7C15 5.89543 14.1046 5 13 5H11M9 5C9 3.89543 9.89543 3 11 3H9C7.89543 3 7 3.89543 7 5M9 5C9 6.10457 9.89543 7 11 7H9C7.89543 7 7 6.10457 7 5M8 10H12M8 13H12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Tasks</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="analytics.html" class="nav-link" data-page="analytics">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 16L3 12M7 16L7 8M11 16L11 10M15 16L15 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="price-recommender.html" class="nav-link active" data-page="price-recommender">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 2C10 2 10 5 10 7M10 7C8 7 6 8 6 10C6 12 8 13 10 13C12 13 14 12 14 10C14 8 12 7 10 7ZM10 13V18M6 18H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Price Snapshot</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="ebay-import.html" class="nav-link" data-page="ebay-import">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 3V13M10 13L6 9M10 13L14 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M3 17H17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            <span>eBay Import</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="sidebar-footer">
            <a href="downloads.html" class="sidebar-footer-link">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 3V13M10 13L6 9M10 13L14 9M3 17H17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Downloads</span>
            </a>
            <button class="sidebar-footer-link sidebar-logout" id="logoutButton">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 15L17 10L13 5M17 10H7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 3H4C3.44772 3 3 3.44772 3 4V16C3 16.5523 3.44772 17 4 17H7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="admin-main">
        <header class="admin-topbar">
            <div class="topbar-left">
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 5H17M3 10H17M3 15H17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
                <h1 class="page-title">Max Bid Calculator</h1>
            </div>
            <div class="topbar-right">
                <div class="topbar-user">
                    <span class="topbar-user-name">Admin</span>
                </div>
            </div>
        </header>

        <div class="admin-content">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="bid-calc">Bid Calculator</button>
                <button class="tab-btn" data-tab="individual">Individual Parts</button>
                <button class="tab-btn" data-tab="full-sets">Full Sets</button>
                <button class="tab-btn" data-tab="best-sellers">Best Sellers</button>
                <button class="tab-btn" data-tab="investment">Investment Optimizer</button>
            </div>

            <!-- Bid Calculator Tab -->
            <div class="tab-content active" id="tab-bid-calc">
                <div class="snapshot-controls">
                    <div class="bid-calculator-form">
                        <div class="form-group">
                            <label>Select Set</label>
                            <select id="bidCalcGeneration">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Parts Included</label>
                            <div style="display:flex;gap:12px;padding:8px 0;">
                                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:0.85rem;">
                                    <input type="checkbox" id="partLeft" checked style="width:16px;height:16px;"> Left
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:0.85rem;">
                                    <input type="checkbox" id="partRight" checked style="width:16px;height:16px;"> Right
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:0.85rem;">
                                    <input type="checkbox" id="partCase" checked style="width:16px;height:16px;"> Case
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Postage Cost</label>
                            <input type="number" id="bidCalcPostage" value="0" min="0" step="0.5" style="width:80px;padding:10px 14px;border:1px solid #d1d5db;border-radius:6px;" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Min Profit Target</label>
                            <input type="number" id="bidCalcProfit" value="10" min="0" step="1" style="width:80px;padding:10px 14px;border:1px solid #d1d5db;border-radius:6px;">
                        </div>
                        <button class="btn btn-primary" onclick="calculateBid()">Calculate</button>
                    </div>
                </div>
                <div id="bidCalcResult">
                    <div class="no-data" style="padding:40px 20px;"><p>Select a set above to calculate the max bid price.</p></div>
                </div>
            </div>

            <!-- Individual Parts Tab -->
            <div class="tab-content" id="tab-individual">
                <div class="snapshot-controls">
                    <label>Min Profit: £<input type="number" id="minProfit" value="10" min="0" step="1"></label>
                    <label>Last <input type="number" id="salesCount" value="5" min="1" max="50"> sales</label>
                    <button class="btn btn-primary" id="refreshBtn" onclick="loadSnapshot()">Refresh</button>
                </div>
                <div id="snapshotContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Full Sets Tab -->
            <div class="tab-content" id="tab-full-sets">
                <div class="snapshot-controls">
                    <label>Min Profit: £<input type="number" id="minProfitSets" value="10" min="0" step="1"></label>
                    <label>Last <input type="number" id="salesCountSets" value="10" min="1" max="50"> sales per part</label>
                    <button class="btn btn-primary" id="refreshBtnSets" onclick="loadFullSets()">Refresh</button>
                </div>
                <div id="fullSetsContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Best Sellers Tab -->
            <div class="tab-content" id="tab-best-sellers">
                <div class="snapshot-controls">
                    <label>Last <input type="number" id="daysBestSellers" value="30" min="1" max="365"> days</label>
                    <button class="btn btn-primary" id="refreshBtnSellers" onclick="loadBestSellers()">Refresh</button>
                </div>
                <div id="bestSellersContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Investment Optimizer Tab -->
            <div class="tab-content" id="tab-investment">
                <div class="snapshot-controls">
                    <label>Budget: £<input type="number" id="investmentBudget" value="500" min="0" step="50" class="budget-input"></label>
                    <label>Min Profit: £<input type="number" id="minProfitInvest" value="10" min="0" step="1"></label>
                    <label>Last <input type="number" id="daysInvest" value="30" min="1" max="365"> days</label>
                    <button class="btn btn-primary" id="refreshBtnInvest" onclick="loadInvestmentOptimizer()">Calculate</button>
                </div>
                <div id="investmentContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="timestamp" id="timestamp"></div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <script src="../js/admin.js?v=1.0.6"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.dataset.tab;

                // Update active button
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Update active content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${tabId}`).classList.add('active');

                // Load data for the tab if not loaded
                if (tabId === 'full-sets' && !window.fullSetsLoaded) {
                    loadFullSets();
                } else if (tabId === 'best-sellers' && !window.bestSellersLoaded) {
                    loadBestSellers();
                } else if (tabId === 'investment' && !window.investmentLoaded) {
                    loadInvestmentOptimizer();
                }
            });
        });

        // Individual Parts Snapshot (existing functionality)
        async function loadSnapshot() {
            const content = document.getElementById('snapshotContent');
            const refreshBtn = document.getElementById('refreshBtn');
            const minProfitEl = document.getElementById('minProfit');
            const salesCountEl = document.getElementById('salesCount');

            if (!content) return;

            const minProfit = minProfitEl ? minProfitEl.value : 10;
            const salesCount = salesCountEl ? salesCountEl.value : 5;

            content.innerHTML = '<div class="loading">Loading...</div>';
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
            }

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                const response = await authenticatedFetch(
                    `/api/admin/price-snapshot?min_profit=${minProfit}&sales_count=${salesCount}`
                );

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to load');
                }

                const data = await response.json();

                if (!data.snapshot || data.snapshot.length === 0) {
                    content.innerHTML = '<div class="no-data"><p>No sales data found.</p><p style="font-size:0.9rem">Record some sales to see max bid recommendations.</p></div>';
                    return;
                }

                content.innerHTML = '<div class="snapshot-grid">' + data.snapshot.map(item => `
                    <div class="snapshot-card">
                        <div class="snapshot-card-header">
                            <span class="generation-name">${item.generation}</span>
                            <span class="sales-count">${item.sales_analyzed} sales</span>
                        </div>
                        <div class="max-bid">£${item.max_bid.toFixed(2)}</div>
                        <div class="max-bid-label">Max bid for £${minProfit} profit</div>
                        <div class="breakdown">
                            <div class="breakdown-row"><span>Avg Sale</span><span>£${item.avg_sale_price.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Fees</span><span class="minus">-£${item.avg_fees.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Consumables</span><span class="minus">-£${item.avg_consumables.toFixed(2)}</span></div>
                            <div class="breakdown-row highlight"><span>Net</span><span>£${item.avg_net_revenue.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Profit</span><span class="minus">-£${item.min_profit.toFixed(2)}</span></div>
                            <div class="breakdown-row highlight"><span>Max Bid</span><span style="color:#0d9488">£${item.max_bid.toFixed(2)}</span></div>
                        </div>
                        ${item.last_sale_date ? `<div class="last-sale">Last: ${new Date(item.last_sale_date).toLocaleDateString()}</div>` : ''}
                    </div>
                `).join('') + '</div>';

                document.getElementById('timestamp').textContent = 'Generated: ' + new Date(data.generated_at).toLocaleString();

            } catch (err) {
                content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh';
                }
            }
        }

        // Full Sets Calculator
        async function loadFullSets() {
            const content = document.getElementById('fullSetsContent');
            const refreshBtn = document.getElementById('refreshBtnSets');
            const minProfitEl = document.getElementById('minProfitSets');
            const salesCountEl = document.getElementById('salesCountSets');

            if (!content) return;

            const minProfit = minProfitEl ? minProfitEl.value : 10;
            const salesCount = salesCountEl ? salesCountEl.value : 10;

            content.innerHTML = '<div class="loading">Loading...</div>';
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
            }

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                const response = await authenticatedFetch(
                    `/api/admin/price-snapshot/full-sets?min_profit=${minProfit}&sales_count=${salesCount}`
                );

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to load');
                }

                const data = await response.json();
                window.fullSetsLoaded = true;

                if (!data.full_sets || data.full_sets.length === 0) {
                    content.innerHTML = '<div class="no-data"><p>No full set data found.</p><p style="font-size:0.9rem">Need sales of individual parts (left, right, case) to calculate full set bids.</p></div>';
                    return;
                }

                content.innerHTML = '<div class="snapshot-grid">' + data.full_sets.map(item => `
                    <div class="snapshot-card">
                        <div class="snapshot-card-header">
                            <span class="generation-name">${item.generation}</span>
                            <span class="sales-count">${item.has_all_parts ? 'All parts' : item.parts_with_data + '/3 parts'}</span>
                        </div>
                        <div class="max-bid">£${item.full_set_max_bid.toFixed(2)}</div>
                        <div class="max-bid-label">Full set max bid for £${minProfit} profit</div>
                        <div class="breakdown">
                            <div class="breakdown-row"><span>Combined Sale Value</span><span>£${item.combined_sale_price.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Total Fees</span><span class="minus">-£${item.combined_fees.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Total Consumables</span><span class="minus">-£${item.combined_consumables.toFixed(2)}</span></div>
                            <div class="breakdown-row highlight"><span>Net Revenue</span><span>£${item.combined_net_revenue.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span>Min Profit</span><span class="minus">-£${item.min_profit.toFixed(2)}</span></div>
                            <div class="breakdown-row highlight"><span>Full Set Max Bid</span><span style="color:#0d9488">£${item.full_set_max_bid.toFixed(2)}</span></div>
                        </div>
                        <div class="parts-breakdown">
                            <div style="font-size:0.75rem;color:#6b7280;margin-bottom:8px;">Parts breakdown:</div>
                            ${['left', 'right', 'case'].map(partType => {
                                const part = item.parts_breakdown[partType];
                                if (part) {
                                    return `<div class="part-row">
                                        <span class="part-type-badge ${partType}">${partType}</span>
                                        <span>£${part.avg_sale_price.toFixed(2)} (${part.sales_analyzed} sales)</span>
                                    </div>`;
                                } else {
                                    return `<div class="part-row">
                                        <span class="part-type-badge ${partType}">${partType}</span>
                                        <span class="part-missing">No data</span>
                                    </div>`;
                                }
                            }).join('')}
                        </div>
                    </div>
                `).join('') + '</div>';

                document.getElementById('timestamp').textContent = 'Generated: ' + new Date(data.generated_at).toLocaleString();

            } catch (err) {
                content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh';
                }
            }
        }

        // Best Sellers Analysis
        async function loadBestSellers() {
            const content = document.getElementById('bestSellersContent');
            const refreshBtn = document.getElementById('refreshBtnSellers');
            const daysEl = document.getElementById('daysBestSellers');

            if (!content) return;

            const days = daysEl ? daysEl.value : 30;

            content.innerHTML = '<div class="loading">Loading...</div>';
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
            }

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                const response = await authenticatedFetch(
                    `/api/admin/price-snapshot/best-sellers?days=${days}`
                );

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to load');
                }

                const data = await response.json();
                window.bestSellersLoaded = true;

                if (!data.best_sellers || data.best_sellers.length === 0) {
                    content.innerHTML = '<div class="no-data"><p>No best seller data found.</p><p style="font-size:0.9rem">Need stock and sales data to analyze best sellers.</p></div>';
                    return;
                }

                content.innerHTML = `
                    <div class="sellers-table-wrapper" style="overflow-x:auto;">
                        <table class="sellers-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Generation</th>
                                    <th>Part</th>
                                    <th>Stock</th>
                                    <th>Sales (${days}d)</th>
                                    <th>Velocity/Day</th>
                                    <th>Days of Stock</th>
                                    <th>Avg Price</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.best_sellers.map(item => `
                                    <tr>
                                        <td><strong>#${item.rank}</strong></td>
                                        <td>${item.generation || 'Unknown'}</td>
                                        <td><span class="part-type-badge ${item.part_type}">${item.part_type || 'N/A'}</span></td>
                                        <td>${item.current_stock}</td>
                                        <td>${item.sales_count}</td>
                                        <td>${item.sales_velocity.toFixed(2)}</td>
                                        <td>${item.days_of_stock !== null ? item.days_of_stock + ' days' : '-'}</td>
                                        <td>£${item.avg_sale_price.toFixed(2)}</td>
                                        <td><span class="velocity-badge ${item.seller_category}">${item.seller_category.replace('_', ' ')}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('timestamp').textContent = 'Generated: ' + new Date(data.generated_at).toLocaleString();

            } catch (err) {
                content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh';
                }
            }
        }

        // Investment Optimizer
        async function loadInvestmentOptimizer() {
            const content = document.getElementById('investmentContent');
            const refreshBtn = document.getElementById('refreshBtnInvest');
            const budgetEl = document.getElementById('investmentBudget');
            const minProfitEl = document.getElementById('minProfitInvest');
            const daysEl = document.getElementById('daysInvest');

            if (!content) return;

            const budget = budgetEl ? budgetEl.value : 500;
            const minProfit = minProfitEl ? minProfitEl.value : 10;
            const days = daysEl ? daysEl.value : 30;

            content.innerHTML = '<div class="loading">Calculating optimal investments...</div>';
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Calculating...';
            }

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                const response = await authenticatedFetch(
                    `/api/admin/price-snapshot/investment-optimizer?budget=${budget}&min_profit=${minProfit}&days=${days}`
                );

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to load');
                }

                const data = await response.json();
                window.investmentLoaded = true;

                if (!data.recommendations || data.recommendations.length === 0) {
                    // Check if there are flagged items
                    if (data.flagged_unrealistic && data.flagged_unrealistic.length > 0) {
                        content.innerHTML = `
                            <div class="no-data"><p>No realistic investment recommendations.</p><p style="font-size:0.9rem">All sets have unrealistic calculated prices based on historical purchase data.</p></div>
                            <div class="flagged-section">
                                <h4>Excluded Sets (Unrealistic Prices)</h4>
                                ${data.flagged_unrealistic.map(item => `
                                    <div class="flagged-item">
                                        <div>
                                            <div class="name">${item.generation}</div>
                                            <div class="reason">${item.price_flag_reason}</div>
                                        </div>
                                        <div class="prices">
                                            Calculated: £${item.calculated_max_bid.toFixed(2)} | Historical: £${item.historical_purchase_price ? item.historical_purchase_price.toFixed(2) : 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        content.innerHTML = '<div class="no-data"><p>No investment recommendations.</p><p style="font-size:0.9rem">Need more sales data or increase budget to generate recommendations.</p></div>';
                    }
                    return;
                }

                const summary = data.summary;

                // Build historical price note helper
                const getHistoricalNote = (rec) => {
                    if (!rec.historical_purchase_price) return '';
                    if (rec.price_flag === 'below_historical') {
                        return `<div class="historical-price-note warning">Historical avg: £${rec.historical_purchase_price.toFixed(2)}</div>`;
                    }
                    return `<div class="historical-price-note">Historical avg: £${rec.historical_purchase_price.toFixed(2)}</div>`;
                };

                // Build price flag badge helper
                const getPriceFlagBadge = (rec) => {
                    if (!rec.price_flag || rec.price_flag === 'realistic') return '';
                    if (rec.price_flag === 'below_historical') {
                        return `<span class="price-flag-badge below_historical">Below avg</span>`;
                    }
                    return '';
                };

                content.innerHTML = `
                    <div class="investment-summary">
                        <div class="summary-card">
                            <div class="label">Budget</div>
                            <div class="value">£${data.budget.toFixed(2)}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Total Investment</div>
                            <div class="value investment">£${summary.total_investment.toFixed(2)}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Expected Profit</div>
                            <div class="value profit">£${summary.total_expected_profit.toFixed(2)}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">ROI</div>
                            <div class="value">${summary.overall_roi_percentage.toFixed(1)}%</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Sets to Buy</div>
                            <div class="value">${summary.total_sets_recommended}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Remaining</div>
                            <div class="value">£${summary.remaining_budget.toFixed(2)}</div>
                        </div>
                    </div>

                    <h3 style="margin:24px 0 16px;color:#1f2937;">Purchase Recommendations</h3>
                    <div class="recommendations-list">
                        ${data.recommendations.map((rec, index) => {
                            const priority = index < 2 ? 'high' : index < 4 ? 'medium' : 'low';
                            return `
                            <div class="recommendation-card">
                                <div class="rec-info">
                                    <h3>
                                        ${rec.generation}
                                        <span class="priority-badge ${priority}">${priority} priority</span>
                                        ${getPriceFlagBadge(rec)}
                                    </h3>
                                    <div class="rec-details">
                                        <span>£${rec.cost_per_set.toFixed(2)} per set</span>
                                        <span>£${rec.expected_profit_per_set.toFixed(2)} profit each</span>
                                        <span>${rec.roi_percentage.toFixed(1)}% ROI</span>
                                        <span>${rec.sales_velocity.toFixed(2)} sales/day</span>
                                    </div>
                                    ${getHistoricalNote(rec)}
                                </div>
                                <div class="rec-action">
                                    <div class="quantity">${rec.recommended_quantity}</div>
                                    <div class="quantity-label">sets</div>
                                    <div style="font-size:0.8rem;color:#6b7280;margin-top:4px;">£${rec.total_cost.toFixed(2)} total</div>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>

                    ${data.flagged_unrealistic && data.flagged_unrealistic.length > 0 ? `
                        <div class="flagged-section">
                            <h4>Excluded Sets (Unrealistic Prices - >10% below historical avg)</h4>
                            ${data.flagged_unrealistic.map(item => `
                                <div class="flagged-item">
                                    <div>
                                        <div class="name">${item.generation}</div>
                                        <div class="reason">${item.price_flag_reason}</div>
                                    </div>
                                    <div class="prices">
                                        Calculated: £${item.calculated_max_bid.toFixed(2)} | Historical: £${item.historical_purchase_price ? item.historical_purchase_price.toFixed(2) : 'N/A'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;

                document.getElementById('timestamp').textContent = 'Generated: ' + new Date(data.generated_at).toLocaleString();

            } catch (err) {
                content.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Calculate';
                }
            }
        }

        // Bid Calculator - Load generation options (ALL generations, not just those with sales data)
        async function loadBidCalcOptions() {
            const select = document.getElementById('bidCalcGeneration');
            if (!select) return;

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                // Get ALL unique generation + connector_type combinations from products
                const response = await authenticatedFetch('/api/admin/price-snapshot/all-generations');
                if (!response.ok) {
                    throw new Error('Failed to load options');
                }

                const data = await response.json();

                select.innerHTML = '<option value="">-- Select a set --</option>';

                if (data.generations && data.generations.length > 0) {
                    for (const gen of data.generations) {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({
                            generation: gen.generation,
                            connector_type: gen.connector_type
                        });
                        option.textContent = gen.display_name;
                        select.appendChild(option);
                    }
                } else {
                    select.innerHTML = '<option value="">No products found</option>';
                }

            } catch (err) {
                select.innerHTML = '<option value="">Error loading options</option>';
                console.error('Error loading bid calc options:', err);
            }
        }

        // Bid Calculator - Calculate max bid for selected set
        async function calculateBid() {
            const select = document.getElementById('bidCalcGeneration');
            const profitInput = document.getElementById('bidCalcProfit');
            const postageInput = document.getElementById('bidCalcPostage');
            const resultDiv = document.getElementById('bidCalcResult');

            // Get selected parts
            const partLeft = document.getElementById('partLeft')?.checked;
            const partRight = document.getElementById('partRight')?.checked;
            const partCase = document.getElementById('partCase')?.checked;

            if (!select || !select.value) {
                resultDiv.innerHTML = '<div class="no-data" style="padding:40px 20px;"><p>Please select a set first.</p></div>';
                return;
            }

            if (!partLeft && !partRight && !partCase) {
                resultDiv.innerHTML = '<div class="no-data" style="padding:40px 20px;"><p>Please select at least one part.</p></div>';
                return;
            }

            const minProfit = parseFloat(profitInput?.value) || 10;
            const postage = parseFloat(postageInput?.value) || 0;
            const selection = JSON.parse(select.value);

            // Build selected parts array
            const selectedParts = [];
            if (partLeft) selectedParts.push('left');
            if (partRight) selectedParts.push('right');
            if (partCase) selectedParts.push('case');

            resultDiv.innerHTML = '<div class="loading">Calculating...</div>';

            try {
                if (typeof authenticatedFetch !== 'function') {
                    throw new Error('Please refresh the page');
                }

                // Fetch the calculation for this specific set
                const params = new URLSearchParams({
                    generation: selection.generation,
                    connector_type: selection.connector_type || '',
                    min_profit: minProfit,
                    postage: postage,
                    parts: selectedParts.join(',')
                });

                const response = await authenticatedFetch(`/api/admin/price-snapshot/bid-calculator?${params}`);
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to calculate');
                }

                const data = await response.json();

                if (!data.success) {
                    // Check if we need to show eBay search suggestions
                    if (data.needs_manual_data && data.ebay_search_suggestions) {
                        let partialDataHtml = '';
                        if (data.parts_with_data && data.parts_with_data.length > 0) {
                            partialDataHtml = `
                                <div style="margin-bottom:20px;">
                                    <h4 style="margin:0 0 12px;color:#374151;">Available Data:</h4>
                                    ${data.parts_with_data.map(partType => {
                                        const part = data.partial_data[partType];
                                        if (part) {
                                            return `<div class="part-row" style="padding:8px 12px;background:#d1fae5;border-radius:6px;margin-bottom:4px;">
                                                <span class="part-type-badge ${partType}">${partType}</span>
                                                <span style="color:#047857;font-weight:600;">£${part.avg_sale_price.toFixed(2)} avg (${part.sales_count} sales)</span>
                                            </div>`;
                                        }
                                        return '';
                                    }).join('')}
                                </div>
                            `;
                        }

                        resultDiv.innerHTML = `
                            <div class="calculator-card" style="max-width:600px;">
                                <h3>${data.display_name}</h3>
                                <div style="padding:16px;background:#fef3c7;border-radius:8px;margin-bottom:20px;">
                                    <p style="margin:0 0 8px;color:#92400e;font-weight:600;">
                                        Insufficient Sales Data: ${data.parts_with_data?.length || 0}/3 parts have data
                                    </p>
                                    <p style="margin:0;color:#92400e;font-size:0.9rem;">
                                        Search eBay for completed listings to estimate prices for the missing parts.
                                    </p>
                                </div>
                                ${partialDataHtml}
                                <div>
                                    <h4 style="margin:0 0 12px;color:#374151;">Missing Parts - Search eBay:</h4>
                                    ${data.ebay_search_suggestions.map(suggestion => `
                                        <div style="padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                                            <div>
                                                <span class="part-type-badge ${suggestion.part_type}">${suggestion.part_type}</span>
                                                <span style="margin-left:8px;color:#6b7280;font-size:0.85rem;">${suggestion.search_query}</span>
                                            </div>
                                            <a href="${suggestion.ebay_url}" target="_blank" rel="noopener"
                                               style="display:inline-block;padding:8px 16px;background:#0d9488;color:white;border-radius:6px;text-decoration:none;font-size:0.85rem;font-weight:500;">
                                                Search eBay Sold Listings
                                            </a>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="margin-top:20px;padding:16px;background:#f0f9ff;border-radius:8px;">
                                    <p style="margin:0;font-size:0.85rem;color:#0369a1;">
                                        <strong>Tip:</strong> Look at completed/sold listings on eBay to find typical selling prices.
                                        Note the average sale price after fees for each missing part, then you can manually calculate your max bid.
                                    </p>
                                </div>
                            </div>
                        `;
                        return;
                    }

                    resultDiv.innerHTML = `<div class="no-data" style="padding:40px 20px;"><p>${data.error || 'Unable to calculate bid for this set.'}</p></div>`;
                    return;
                }

                const calc = data.calculation;
                const selectedParts = data.selected_parts || ['left', 'right', 'case'];
                const partLabels = { left: 'Left Earbud', right: 'Right Earbud', case: 'Charging Case' };

                // Build parts description
                const partsDesc = selectedParts.length === 3 ? 'full set' : selectedParts.map(p => partLabels[p]).join(' + ');

                // Build stock level display for each part
                const buildStockBadge = (partType) => {
                    const stock = data.stock_levels?.[partType] || 0;
                    const isHigh = stock >= 5;
                    return `<span style="margin-left:8px;padding:2px 6px;border-radius:4px;font-size:0.7rem;background:${isHigh ? '#fef3c7' : '#d1fae5'};color:${isHigh ? '#92400e' : '#047857'};">${stock} in stock</span>`;
                };

                // Build the result HTML
                resultDiv.innerHTML = `
                    ${data.has_high_stock ? `
                        <div style="margin-bottom:20px;padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;max-width:500px;">
                            <p style="margin:0 0 8px;color:#b91c1c;font-weight:600;">Stock Warning</p>
                            <p style="margin:0;font-size:0.85rem;color:#991b1b;">
                                You already have high stock levels for some of these parts. Consider whether you need more:
                            </p>
                            <ul style="margin:8px 0 0;padding-left:20px;font-size:0.85rem;color:#991b1b;">
                                ${data.stock_warnings.map(w => `<li>${w.message}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    <div class="calculator-result">
                        <div class="calculator-card">
                            <h3>${data.display_name} <span style="font-size:0.8rem;color:#6b7280;font-weight:normal;">(${partsDesc})</span></h3>

                            <div class="calc-section-title">Expected Sale Revenue (per part)</div>
                            ${selectedParts.includes('left') ? (calc.parts.left ? `
                                <div class="calc-row indent">
                                    <span>Left Earbud ${buildStockBadge('left')}</span>
                                    <span>£${calc.parts.left.avg_sale_price.toFixed(2)}</span>
                                </div>
                            ` : '<div class="calc-row indent"><span>Left Earbud</span><span class="no-data-part">No data</span></div>') : ''}
                            ${selectedParts.includes('right') ? (calc.parts.right ? `
                                <div class="calc-row indent">
                                    <span>Right Earbud ${buildStockBadge('right')}</span>
                                    <span>£${calc.parts.right.avg_sale_price.toFixed(2)}</span>
                                </div>
                            ` : '<div class="calc-row indent"><span>Right Earbud</span><span class="no-data-part">No data</span></div>') : ''}
                            ${selectedParts.includes('case') ? (calc.parts.case ? `
                                <div class="calc-row indent">
                                    <span>Charging Case ${buildStockBadge('case')}</span>
                                    <span>£${calc.parts.case.avg_sale_price.toFixed(2)}</span>
                                </div>
                            ` : '<div class="calc-row indent"><span>Charging Case</span><span class="no-data-part">No data</span></div>') : ''}
                            <div class="calc-row subtotal">
                                <span>Combined Sale Value</span>
                                <span>£${calc.combined_sale_price.toFixed(2)}</span>
                            </div>

                            <div class="calc-section-title">Deductions</div>
                            <div class="calc-row">
                                <span>Platform Fees (avg)</span>
                                <span class="minus">-£${calc.combined_fees.toFixed(2)}</span>
                            </div>
                            <div class="calc-row">
                                <span>Consumables (avg)</span>
                                <span class="minus">-£${calc.combined_consumables.toFixed(2)}</span>
                            </div>
                            <div class="calc-row subtotal">
                                <span>Net Revenue</span>
                                <span>£${calc.net_revenue.toFixed(2)}</span>
                            </div>

                            <div class="calc-section-title">Purchase Costs</div>
                            ${postage > 0 ? `
                            <div class="calc-row">
                                <span>Postage Cost</span>
                                <span class="minus">-£${postage.toFixed(2)}</span>
                            </div>
                            ` : ''}
                            <div class="calc-row">
                                <span>Minimum Profit Target</span>
                                <span class="minus">-£${minProfit.toFixed(2)}</span>
                            </div>

                            <div class="calc-row total">
                                <span>Max Bid Price</span>
                                <span>£${calc.max_bid.toFixed(2)}</span>
                            </div>
                        </div>

                        ${data.historical_price ? `
                            <div class="historical-comparison" style="max-width:500px;margin-top:20px;">
                                <h4>Historical Purchase Price Comparison</h4>
                                <div class="comparison-row">
                                    <span>Avg purchase price (from your data)</span>
                                    <span>£${data.historical_price.toFixed(2)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span>Calculated max bid</span>
                                    <span>£${calc.max_bid.toFixed(2)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span>Difference</span>
                                    <span style="color:${calc.max_bid >= data.historical_price ? '#10b981' : '#ef4444'}">
                                        ${calc.max_bid >= data.historical_price ? '+' : ''}£${(calc.max_bid - data.historical_price).toFixed(2)}
                                        (${((calc.max_bid - data.historical_price) / data.historical_price * 100).toFixed(1)}%)
                                    </span>
                                </div>
                                <div class="verdict ${calc.max_bid >= data.historical_price ? 'good' : calc.max_bid >= data.historical_price * 0.9 ? 'warning' : 'bad'}">
                                    ${calc.max_bid >= data.historical_price
                                        ? 'Max bid is achievable based on historical purchases'
                                        : calc.max_bid >= data.historical_price * 0.9
                                            ? 'Max bid is slightly below historical avg - may be difficult to achieve'
                                            : 'Max bid is significantly below historical avg - unlikely to find at this price'}
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-top:20px;padding:16px;background:${data.has_high_stock ? '#fef3c7' : '#f0fdf4'};border-radius:8px;max-width:500px;">
                            <p style="margin:0;font-size:0.85rem;color:${data.has_high_stock ? '#92400e' : '#166534'};">
                                <strong>Summary:</strong> To make £${minProfit.toFixed(2)} profit on ${data.display_name} (${partsDesc})${postage > 0 ? ` with £${postage.toFixed(2)} postage` : ''},
                                you should bid no more than <strong>£${calc.max_bid.toFixed(2)}</strong>.
                                ${data.has_high_stock ? '<br><strong>Note:</strong> Consider your current stock levels before purchasing.' : ''}
                            </p>
                        </div>
                    </div>
                `;

            } catch (err) {
                resultDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadBidCalcOptions, 200);
        });
    </script>
</body>
</html>
